<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch L√†m Vi·ªác Pro</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">

    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- T·∫£i FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/vi.global.min.js'></script>

    <!-- T·∫£i SheetJS (Th∆∞ vi·ªán xu·∫•t Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* --- T√ôY CH·ªàNH FULLCALENDAR --- */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-today-bg-color: #fffbeb;
            --fc-page-bg-color: #ffffff;
            --fc-neutral-bg-color: #f1f5f9;
            --fc-list-event-hover-bg-color: #f1f5f9;
        }

        .fc .fc-toolbar-title {
            font-size: 1.25rem;
            /* Gi·∫£m font title tr√™n mobile */
            font-weight: 700;
            color: #1e293b;
        }

        @media (min-width: 768px) {
            .fc .fc-toolbar-title {
                font-size: 1.5rem;
            }
        }

        .fc .fc-button {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            /* Padding nh·ªè h∆°n tr√™n mobile */
            font-size: 0.85rem;
            text-transform: capitalize;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            background-color: #3b82f6;
            border-color: #3b82f6;
        }

        @media (min-width: 768px) {
            .fc .fc-button {
                padding: 0.5rem 1.25rem;
                font-size: 1rem;
            }
        }

        .fc .fc-button:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        /* Responsive Toolbar: Stack on mobile */
        @media (max-width: 640px) {
            .fc-header-toolbar {
                flex-direction: column;
                gap: 0.5rem;
            }

            .fc-toolbar-chunk {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }
        }

        .fc-col-header-cell {
            background-color: #f8fafc;
            padding: 8px 0;
            border-bottom: 2px solid #e2e8f0;
        }

        .fc-col-header-cell-cushion {
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            /* Font nh·ªè h∆°n tr√™n mobile */
            text-decoration: none;
        }

        .fc-daygrid-day-number {
            color: #475569;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .fc-day-today .fc-daygrid-day-number {
            background-color: #3b82f6;
            color: white;
        }

        /* Custom Event Style */
        .custom-event {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.7rem;
            /* Font nh·ªè h∆°n */
            font-weight: 600;
            width: 100%;
            height: 100%;
            overflow: hidden;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.2;
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
        }

        .custom-event:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            z-index: 10;
        }

        .event-time-badge {
            font-size: 0.65rem;
            opacity: 0.9;
            white-space: nowrap;
            margin-bottom: 1px;
            font-weight: 700;
        }

        .event-title-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .event-icon {
            margin-right: 3px;
            font-size: 0.75rem;
        }

        .event-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s;
            background-color: #f8fafc;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:disabled {
            background-color: #e2e8f0;
            color: #64748b;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="flex flex-col h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 z-30 shadow-sm flex-none">
        <div class="max-w-full mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left: Logo & Back Button -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <!-- N√∫t Menu cho Mobile -->
                    <button id="menuOpenButton"
                        class="lg:hidden text-gray-600 p-2 rounded hover:bg-gray-100 focus:outline-none">
                        <i class="bi bi-list text-2xl"></i>
                    </button>

                    <a href="index.html"
                        class="flex items-center justify-center bg-slate-100 hover:bg-slate-200 text-slate-600 p-2 rounded-lg transition"
                        title="Quay l·∫°i Dashboard">
                        <i class="bi bi-arrow-left text-lg sm:text-xl"></i>
                    </a>

                    <div class="bg-blue-600 p-2 rounded-lg text-white shadow-md hidden sm:block">
                        <i class="bi bi-calendar-check-fill text-xl"></i>
                    </div>
                    <h1 class="text-lg sm:text-xl font-bold text-slate-800 tracking-tight truncate">L·ªãch L√†m Vi·ªác</h1>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <!-- Search & Filter ·∫©n tr√™n mobile, ƒë∆∞a v√†o sidebar -->
                    <div class="relative hidden lg:block">
                        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..."
                            class="pl-10 pr-4 py-2 bg-slate-100 border-none rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 transition">
                        <i class="bi bi-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    </div>

                    <div class="hidden xl:block relative">
                        <select id="categoryFilterDesktop"
                            class="appearance-none pl-9 pr-8 py-2 bg-slate-100 border-none rounded-full text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            <option value="all">T·∫•t c·∫£ ph√¢n lo·∫°i</option>
                        </select>
                        <i
                            class="bi bi-funnel-fill absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500"></i>
                        <i
                            class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-slate-500"></i>
                    </div>

                    <!-- N√∫t Th√™m m·ªõi: Ch·ªâ hi·ªán icon tr√™n mobile -->
                    <button onclick="openModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 sm:px-4 sm:py-2 rounded-full text-sm font-medium shadow-md transition flex items-center gap-2 transform active:scale-95">
                        <i class="bi bi-plus-lg text-lg"></i> <span class="hidden sm:inline">Th√™m m·ªõi</span>
                    </button>

                    <!-- N√∫t Xu·∫•t Excel: ·∫®n tr√™n mobile -->
                    <button onclick="exportExcel()"
                        class="hidden sm:flex bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-full text-sm font-medium shadow-md transition items-center gap-2 transform active:scale-95">
                        <i class="bi bi-file-earmark-excel-fill"></i> <span class="hidden sm:inline">Xu·∫•t Excel</span>
                    </button>

                    <!-- Auth UI: T·ªëi gi·∫£n tr√™n mobile -->
                    <div id="authContainer" class="ml-1 sm:ml-2">
                        <button id="btnLogin"
                            class="hidden text-xs sm:text-sm bg-white border border-blue-500 text-blue-500 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full hover:bg-blue-50 transition">ƒêƒÉng
                            nh·∫≠p</button>
                        <div id="userProfile" class="hidden flex items-center gap-2">
                            <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-slate-300"
                                alt="Avatar">
                            <button id="btnLogout"
                                class="hidden sm:block text-xs text-red-500 hover:underline">Tho√°t</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-2 sm:p-4 bg-slate-50 overflow-y-auto flex flex-col">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 flex-1 p-2 sm:p-4 relative">
            <div id="calendar" class="h-full"></div>
        </div>
    </main>

    <!-- Sidebar Mobile -->
    <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity"></div>
    <div id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800"><i class="bi bi-menu-button-wide mr-2"></i>Menu</h2>
            <button id="menuCloseButton" class="text-gray-500 hover:text-red-500 transition"><i
                    class="bi bi-x-lg text-xl"></i></button>
        </div>
        <div class="p-4 flex flex-col gap-4 overflow-y-auto flex-1">
            <!-- Mobile Search -->
            <div class="relative">
                <input type="text" id="searchInputMobile" placeholder="T√¨m ki·∫øm..."
                    class="pl-9 pr-4 py-2 bg-slate-100 border-none rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                <i class="bi bi-search absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            </div>

            <!-- Mobile Filter -->
            <div class="relative">
                <select id="categoryFilterMobile"
                    class="appearance-none pl-9 pr-8 py-2 bg-slate-100 border-none rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 w-full cursor-pointer">
                    <option value="all">T·∫•t c·∫£ ph√¢n lo·∫°i</option>
                </select>
                <i class="bi bi-funnel-fill absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500"></i>
                <i
                    class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-slate-500"></i>
            </div>

            <hr class="border-gray-200">

            <a href="index.html"
                class="flex items-center gap-3 p-3 bg-slate-50 hover:bg-slate-100 rounded-lg transition text-slate-700 font-medium">
                <i class="bi bi-house-door-fill text-lg text-blue-600"></i> V·ªÅ Dashboard
            </a>

            <button onclick="exportExcel()"
                class="flex items-center gap-3 p-3 bg-slate-50 hover:bg-slate-100 rounded-lg transition text-slate-700 font-medium w-full text-left">
                <i class="bi bi-file-earmark-excel-fill text-lg text-emerald-600"></i> Xu·∫•t Excel
            </button>

            <div id="mobileLogoutContainer" class="mt-auto pt-4 border-t border-gray-100">
                <button id="btnLogoutMobile"
                    class="flex items-center gap-3 p-3 w-full text-red-600 hover:bg-red-50 rounded-lg transition font-medium">
                    <i class="bi bi-box-arrow-right text-lg"></i> ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Form (Responsive) -->
    <div id="taskModal" class="fixed inset-0 z-50 hidden transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>

        <!-- Responsive Width & Padding -->
        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[95%] sm:w-full max-w-2xl bg-white rounded-xl sm:rounded-2xl shadow-2xl overflow-hidden scale-100 transition-transform duration-300 max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div
                class="px-4 sm:px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-white flex-none">
                <h3 class="text-base sm:text-lg font-bold text-slate-800" id="modalTitle">C√¥ng vi·ªác m·ªõi</h3>
                <button onclick="closeModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="p-4 sm:p-5 space-y-3 overflow-y-auto flex-1">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <input type="hidden" id="taskId">

                    <!-- Responsive Grid: 1 c·ªôt tr√™n mobile, 3 c·ªôt tr√™n desktop -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <div class="sm:col-span-2">
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">T√™n c√¥ng vi·ªác <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="taskName" required placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác..."
                                class="form-input">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Tr·∫°ng th√°i</label>
                            <select id="taskStatus" class="form-input cursor-pointer">
                                <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                                <option value="Ch∆∞a th·ª±c hi·ªán">Ch∆∞a th·ª±c hi·ªán</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Danh m·ª•c</label>
                        <select id="taskCategory" class="form-input cursor-pointer"
                            onchange="toggleCustomCategory(this)">
                            <!-- JS populated -->
                        </select>
                        <input type="text" id="customCategoryInput" class="form-input mt-2 hidden"
                            placeholder="Nh·∫≠p t√™n danh m·ª•c m·ªõi">
                    </div>

                    <!-- Responsive Grid cho Ng√†y/Gi·ªù -->
                    <div
                        class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input type="date" id="taskStartDate" required class="form-input"
                                onchange="calculateDeadline()">
                        </div>
                        <div class="grid grid-cols-2 sm:block gap-3"> <!-- Chia ƒë√¥i tr√™n mobile cho g·ªçn -->
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Th·ªùi l∆∞·ª£ng
                                    (Ng√†y)</label>
                                <input type="number" id="taskDuration" value="1" min="0" class="form-input"
                                    oninput="calculateDeadline()">
                            </div>
                            <div class="sm:mt-3 sm:hidden"> <!-- ·∫®n label tr√™n mobile n·∫øu mu·ªën ho·∫∑c gi·ªØ nguy√™n -->
                                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">H·∫°n cu·ªëi
                                    (Auto)</label>
                                <input type="date" id="taskDeadlineMobile" disabled
                                    class="form-input bg-white text-slate-500 font-bold border-slate-200">
                            </div>
                        </div>
                        <div class="hidden sm:block"> <!-- Ch·ªâ hi·ªán tr√™n desktop, mobile d√πng √¥ tr√™n -->
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">H·∫°n cu·ªëi (Auto)</label>
                            <input type="date" id="taskDeadline" disabled
                                class="form-input bg-white text-slate-500 font-bold border-slate-200">
                        </div>
                    </div>

                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-700 mb-2 flex items-center gap-2 uppercase">
                            <i class="bi bi-clock"></i> Khung gi·ªù l√†m vi·ªác
                        </h4>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4">
                            <div class="flex items-center gap-2 w-full">
                                <div class="flex-1">
                                    <input type="time" id="taskStartTime" class="form-input text-sm"
                                        onchange="calculateHours()">
                                </div>
                                <span class="text-slate-400 font-bold">-</span>
                                <div class="flex-1">
                                    <input type="time" id="taskEndTime" class="form-input text-sm"
                                        onchange="calculateHours()">
                                </div>
                            </div>
                            <div id="hourDurationText"
                                class="text-xs text-blue-600 font-bold whitespace-nowrap w-full sm:w-auto text-left sm:text-right mt-1 sm:mt-0">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Ghi ch√∫</label>
                        <textarea id="taskNote" rows="2" placeholder="Ghi ch√∫ th√™m..."
                            class="form-input resize-none"></textarea>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div
                class="px-4 sm:px-5 py-3 border-t border-slate-100 bg-gray-50 flex justify-between items-center flex-none">
                <button type="button" id="deleteBtn" onclick="deleteTask()"
                    class="hidden text-red-600 hover:text-red-700 text-sm font-bold px-3 py-2 rounded hover:bg-red-50 transition flex items-center gap-2">
                    <i class="bi bi-trash"></i> <span class="hidden sm:inline">X√≥a</span>
                </button>
                <div class="flex gap-3 ml-auto">
                    <button type="button" onclick="closeModal()"
                        class="px-3 sm:px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 text-sm font-bold transition">H·ªßy</button>
                    <button type="button"
                        onclick="document.getElementById('taskForm').dispatchEvent(new Event('submit'))"
                        class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow-md transition">L∆∞u
                        l·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-6 right-6 sm:right-6 left-6 sm:left-auto bg-slate-800 text-white px-4 sm:px-5 py-3 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-[60] flex items-center gap-3 justify-center sm:justify-start">
        <div class="bg-green-500 rounded-full p-1 flex-shrink-0"><i class="bi bi-check text-white text-sm"></i></div>
        <span id="toastMsg" class="font-medium text-sm truncate">Th√†nh c√¥ng</span>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDILs6zPfC0UdPL7crGbAot-w2vt5eCGgk",
            authDomain: "flutter-ai-playground-c65f3.firebaseapp.com",
            projectId: "flutter-ai-playground-c65f3",
            storageBucket: "flutter-ai-playground-c65f3.appspot.com",
            messagingSenderId: "932092331324",
            appId: "1:932092331324:web:dcbb33b44b5d55a43cca39"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const btnLogin = document.getElementById('btnLogin');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const btnLogout = document.getElementById('btnLogout');
        const btnLogoutMobile = document.getElementById('btnLogoutMobile'); // Mobile Logout

        // Auth Functions
        const handleLogin = () => signInWithPopup(auth, provider).catch(e => showToast(e.message, true));
        const handleLogout = () => signOut(auth);

        if (btnLogin) btnLogin.addEventListener('click', handleLogin);
        if (btnLogout) btnLogout.addEventListener('click', handleLogout);
        if (btnLogoutMobile) btnLogoutMobile.addEventListener('click', handleLogout);

        onAuthStateChanged(auth, user => {
            if (user) {
                btnLogin.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userAvatar.src = user.photoURL;

                // Mobile Sidebar State
                const mobileLogoutContainer = document.getElementById('mobileLogoutContainer');
                if (mobileLogoutContainer) mobileLogoutContainer.classList.remove('hidden');
            } else {
                btnLogin.classList.remove('hidden');
                userProfile.classList.add('hidden');

                // Mobile Sidebar State
                const mobileLogoutContainer = document.getElementById('mobileLogoutContainer');
                if (mobileLogoutContainer) mobileLogoutContainer.classList.add('hidden');
            }
        });

        window.tasks = [];
        const q = query(collection(db, "tasks"), orderBy("deadline"));

        onSnapshot(q, (snapshot) => {
            window.tasks = snapshot.docs.map(doc => {
                const data = doc.data();
                return { id: doc.id, ...data };
            });
            if (window.calendar) window.calendar.refetchEvents();

            // Update dropdowns for both Desktop & Mobile
            const dynamicCats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
            window.tasks.forEach(t => { if (t.category) dynamicCats.add(t.category); });

            if (window.updateFilterDropdown) {
                window.updateFilterDropdown(dynamicCats, 'categoryFilterDesktop');
                window.updateFilterDropdown(dynamicCats, 'categoryFilterMobile');
            }
            if (window.updateModalDropdown) window.updateModalDropdown(dynamicCats);
        });

        window.dbActions = {
            add: async (data) => addDoc(collection(db, "tasks"), { ...data, createdAt: serverTimestamp() }),
            update: async (id, data) => updateDoc(doc(db, "tasks", id), data),
            delete: async (id) => deleteDoc(doc(db, "tasks", id))
        };
    </script>

    <!-- MAIN APP LOGIC -->
    <script>
        const CATEGORIES = [
            { id: 'Gi·∫£ng d·∫°y', name: 'Gi·∫£ng d·∫°y', color: '#0d6efd' },
            { id: 'H·ªçp', name: 'H·ªçp', color: '#fd7e14' },
            { id: 'Coi thi', name: 'Coi thi', color: '#dc3545' },
            { id: 'Vi·ªác c√° nh√¢n', name: 'Vi·ªác c√° nh√¢n', color: '#64748b' }
        ];

        window.calendar = null;

        document.addEventListener('DOMContentLoaded', function () {
            populateCategorySelects();
            initCalendar();
            setupSearch();
            setupSidebar();

            // Sync Mobile/Desktop Filter
            const mobileFilter = document.getElementById('categoryFilterMobile');
            const desktopFilter = document.getElementById('categoryFilterDesktop');

            mobileFilter.addEventListener('change', (e) => {
                desktopFilter.value = e.target.value;
                if (window.calendar) window.calendar.refetchEvents();
            });
        });

        function populateCategorySelects() {
            const formSelect = document.getElementById('taskCategory');
            // Initial population
            formSelect.innerHTML = '';
            CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = cat.name;
                formSelect.appendChild(opt);
            });
        }

        // Make this global to be called from module script
        window.updateFilterDropdown = function (categories, elementId) {
            const filterSelect = document.getElementById(elementId);
            if (!filterSelect) return;

            const currentVal = filterSelect.value;
            while (filterSelect.options.length > 1) filterSelect.remove(1);
            categories.forEach(cat => filterSelect.add(new Option(cat, cat)));
            if (Array.from(filterSelect.options).some(o => o.value === currentVal)) filterSelect.value = currentVal;
        }

        window.updateModalDropdown = function (categories) {
            const modalSelect = document.getElementById('taskCategory');
            if (modalSelect.value === '__other__') return;
            const currentVal = modalSelect.value;
            modalSelect.innerHTML = '';
            categories.forEach(cat => modalSelect.add(new Option(cat, cat)));
            const otherOpt = new Option('+ Nh·∫≠p danh m·ª•c m·ªõi...', '__other__');
            otherOpt.className = "fw-bold text-primary";
            modalSelect.add(otherOpt);
            if (Array.from(modalSelect.options).some(o => o.value === currentVal)) modalSelect.value = currentVal;
        }

        function getCategoryColor(catName) {
            // Helper color function...
            const colors = ['#0d6efd', '#fd7e14', '#dc3545', '#64748b', '#6610f2', '#0dcaf0'];
            let hash = 0;
            for (let i = 0; i < catName.length; i++) hash = catName.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash % 360)}, 70%, 50%)`;
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            const isMobile = window.innerWidth < 768;

            window.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: isMobile ? 'timeGridDay' : 'dayGridMonth', // Mobile ∆∞u ti√™n xem Ng√†y
                locale: 'vi',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'timeGridDay,listMonth' : 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: { today: 'H√¥m nay', month: 'Th√°ng', week: 'Tu·∫ßn', day: 'Ng√†y', list: 'DS' },
                height: '100%', // Full height container
                aspectRatio: isMobile ? 0.8 : 1.35,
                dayMaxEvents: true, // Thu g·ªçn n·∫øu qu√° nhi·ªÅu
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: true,
                views: {
                    timeGridDay: { titleFormat: { month: 'short', day: 'numeric', weekday: 'short' } }
                },

                // Events logic same as before...
                events: function (info, successCallback) {
                    const filterCat = document.getElementById('categoryFilterDesktop').value;
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase() || document.getElementById('searchInputMobile').value.toLowerCase();
                    const allTasks = window.tasks || [];

                    let filtered = allTasks.filter(t => {
                        const matchCat = filterCat === 'all' || t.category === filterCat;
                        const matchSearch = t.name && t.name.toLowerCase().includes(searchTerm);
                        return matchCat && matchSearch;
                    });

                    successCallback(filtered.map(t => {
                        let baseDate = t.deadline;
                        let startISO = baseDate;
                        let endISO = null;
                        let isAllDay = true;

                        if (t.startTime) {
                            startISO = `${baseDate}T${t.startTime}`;
                            isAllDay = false;
                            if (t.endTime) endISO = `${baseDate}T${t.endTime}`;
                        }

                        return {
                            id: t.id,
                            title: t.name,
                            start: startISO,
                            end: endISO,
                            allDay: isAllDay,
                            extendedProps: { ...t }
                        }
                    }));
                },

                eventContent: function (arg) {
                    const props = arg.event.extendedProps;
                    const bgColor = getCategoryColor(props.category);

                    // Optimized content for small cards
                    let timeDisplay = '';
                    if (!arg.event.allDay && props.startTime) {
                        timeDisplay = `<div class="event-time-badge">${props.startTime}</div>`;
                    }

                    return {
                        html: `
                            <div class="custom-event" style="background-color: ${bgColor}; border-left: 3px solid rgba(0,0,0,0.2);">
                                ${timeDisplay}
                                <div class="event-title font-bold truncate">${arg.event.title}</div>
                            </div>
                        `
                    };
                },

                dateClick: function (info) { openModal(null, info.dateStr); },
                eventClick: function (info) {
                    const id = info.event.id;
                    const task = (window.tasks || []).find(t => t.id === id);
                    if (task) openModal(task);
                },

                // Auto resize handling
                windowResize: function (view) {
                    if (window.innerWidth < 768) {
                        window.calendar.changeView('timeGridDay');
                    } else {
                        window.calendar.changeView('dayGridMonth');
                    }
                }
            });
            window.calendar.render();
        }

        // --- HELPER FUNCTIONS ---
        function addDays(dateStr, days) {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setDate(result.getDate() + parseInt(days));
            return result.toISOString().split('T')[0];
        }

        function subtractDays(dateStr, days) {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setDate(result.getDate() - parseInt(days));
            return result.toISOString().split('T')[0];
        }

        window.calculateDeadline = function () {
            const start = document.getElementById('taskStartDate').value;
            const dur = document.getElementById('taskDuration').value || 0;
            if (start) {
                const deadline = addDays(start, dur);
                document.getElementById('taskDeadline').value = deadline;
                // Update mobile readonly input too
                const mobileDeadline = document.getElementById('taskDeadlineMobile');
                if (mobileDeadline) mobileDeadline.value = deadline;
            }
        }

        window.calculateHours = function () {
            const start = document.getElementById('taskStartTime').value;
            const end = document.getElementById('taskEndTime').value;
            const output = document.getElementById('hourDurationText');

            if (start && end) {
                const s = new Date("1970-01-01 " + start);
                const e = new Date("1970-01-01 " + end);
                let diffMs = e - s;
                if (diffMs < 0) {
                    output.innerText = "L·ªói gi·ªù";
                    output.classList.add('text-red-500');
                    return;
                }
                output.classList.remove('text-red-500');
                const diffHrs = Math.floor((diffMs % 86400000) / 3600000);
                const diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000);
                output.innerText = `${diffHrs}h ${diffMins}p`;
            } else {
                output.innerText = "";
            }
        }

        window.toggleCustomCategory = function (select) {
            const input = document.getElementById('customCategoryInput');
            if (select.value === '__other__') {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        function openModal(task = null, dateStr = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteBtn');
            const customInput = document.getElementById('customCategoryInput');

            form.reset();
            customInput.classList.add('hidden');
            document.getElementById('hourDurationText').innerText = "";

            // Sync logic similar to previous...
            const dynamicCats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
            if (window.tasks) window.tasks.forEach(t => { if (t.category) dynamicCats.add(t.category); });
            updateModalDropdown(dynamicCats);

            if (task) {
                title.innerText = 'C·∫≠p nh·∫≠t';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;

                const catSelect = document.getElementById('taskCategory');
                if ([...catSelect.options].some(o => o.value === task.category)) {
                    catSelect.value = task.category;
                } else {
                    catSelect.value = '__other__';
                    customInput.value = task.category;
                    customInput.classList.remove('hidden');
                }

                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskStartDate').value = task.createdDate || '';
                document.getElementById('taskDuration').value = task.duration || 0;
                document.getElementById('taskDeadline').value = task.deadline || '';
                // Mobile sync
                const mobileDL = document.getElementById('taskDeadlineMobile');
                if (mobileDL) mobileDL.value = task.deadline || '';

                document.getElementById('taskStartTime').value = task.startTime || '';
                document.getElementById('taskEndTime').value = task.endTime || '';
                calculateHours();

                document.getElementById('taskNote').value = task.note || '';
                deleteBtn.classList.remove('hidden');
            } else {
                title.innerText = 'Th√™m m·ªõi';
                document.getElementById('taskId').value = '';

                const defaultDuration = 1;
                let startDate, deadlineDate, startTime = '';

                if (dateStr) {
                    if (dateStr.includes('T')) {
                        const parts = dateStr.split('T');
                        deadlineDate = parts[0];
                        startDate = subtractDays(deadlineDate, defaultDuration);
                        startTime = parts[1].substring(0, 5);
                    } else {
                        deadlineDate = dateStr;
                        startDate = subtractDays(deadlineDate, defaultDuration);
                        const now = new Date();
                        const currentHour = now.getHours();
                        startTime = (currentHour + 1).toString().padStart(2, '0') + ":00";
                    }
                } else {
                    startDate = new Date().toISOString().split('T')[0];
                    deadlineDate = addDays(startDate, defaultDuration);
                    const now = new Date();
                    const currentHour = now.getHours();
                    startTime = (currentHour + 1).toString().padStart(2, '0') + ":00";
                }

                document.getElementById('taskStartDate').value = startDate;
                document.getElementById('taskDuration').value = defaultDuration;
                document.getElementById('taskDeadline').value = deadlineDate;
                const mobileDL = document.getElementById('taskDeadlineMobile');
                if (mobileDL) mobileDL.value = deadlineDate;

                document.getElementById('taskStartTime').value = startTime;
                // Set end time +1h logic
                if (startTime) {
                    const [h, m] = startTime.split(':').map(Number);
                    const endH = (h + 1) % 24;
                    document.getElementById('taskEndTime').value = endH.toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');
                }

                calculateHours();
                document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                document.getElementById('taskStatus').value = 'ƒêang th·ª±c hi·ªán';
                deleteBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        window.closeModal = function () {
            document.getElementById('taskModal').classList.add('hidden');
        }

        window.saveTask = async function (e) {
            e.preventDefault();
            const id = document.getElementById('taskId').value;

            // Logic saving... (Same as before)
            const startDate = document.getElementById('taskStartDate').value;
            let duration = document.getElementById('taskDuration').value || 0;
            const status = document.getElementById('taskStatus').value;

            let priority = 'Trung b√¨nh';
            if (status === 'Ch∆∞a th·ª±c hi·ªán' || status === 'Ho√†n th√†nh') {
                priority = 'Th·∫•p';
                if (status === 'Ho√†n th√†nh') duration = 0;
            } else {
                const deadlineCheck = addDays(startDate, duration);
                const daysLeft = Math.ceil((new Date(deadlineCheck) - new Date().setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 3) priority = 'Cao';
                else if (daysLeft >= 10) priority = 'Th·∫•p';
            }

            const deadline = addDays(startDate, duration);
            let category = document.getElementById('taskCategory').value;
            if (category === '__other__') {
                category = document.getElementById('customCategoryInput').value.trim();
                if (!category) return alert("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c m·ªõi");
            }

            const taskData = {
                name: document.getElementById('taskName').value,
                category: category,
                status: status,
                priority: priority,
                createdDate: startDate,
                duration: duration,
                deadline: deadline,
                startTime: document.getElementById('taskStartTime').value,
                endTime: document.getElementById('taskEndTime').value,
                note: document.getElementById('taskNote').value
            };

            try {
                if (window.dbActions) {
                    if (id) {
                        await window.dbActions.update(id, taskData);
                        showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    } else {
                        await window.dbActions.add(taskData);
                        showToast("Th√™m m·ªõi th√†nh c√¥ng!");
                    }

                    if (document.getElementById('taskCategory').value === '__other__') {
                        document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                        document.getElementById('customCategoryInput').classList.add('hidden');
                    }
                    closeModal();
                } else {
                    alert("L·ªói k·∫øt n·ªëi DB");
                }
            } catch (err) {
                console.error(err);
                showToast("L·ªói: " + err.message, true);
            }
        }

        window.deleteTask = async function () {
            const id = document.getElementById('taskId').value;
            if (id && confirm('X√≥a c√¥ng vi·ªác n√†y?')) {
                try {
                    await window.dbActions.delete(id);
                    showToast("ƒê√£ x√≥a!");
                    closeModal();
                } catch (e) {
                    showToast("L·ªói x√≥a: " + e.message, true);
                }
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            if (isError) toast.querySelector('div').classList.replace('bg-green-500', 'bg-red-500');
            else toast.querySelector('div').classList.replace('bg-red-500', 'bg-green-500');

            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        window.exportExcel = function () {
            const allTasks = window.tasks || [];
            if (allTasks.length === 0) return showToast("Kh√¥ng c√≥ d·ªØ li·ªáu", true);
            const ws = XLSX.utils.json_to_sheet(allTasks);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CongViec");
            XLSX.writeFile(wb, "LichLamViec.xlsx");
        }

        function setupSearch() {
            const searchDesktop = document.getElementById('searchInput');
            const searchMobile = document.getElementById('searchInputMobile');

            const handleSearch = () => { if (window.calendar) window.calendar.refetchEvents(); };

            if (searchDesktop) searchDesktop.addEventListener('input', handleSearch);
            if (searchMobile) searchMobile.addEventListener('input', handleSearch);
        }

        function setupSidebar() {
            const menuOpenBtn = document.getElementById('menuOpenButton');
            const menuCloseBtn = document.getElementById('menuCloseButton');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function openSidebar() {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            }
            function closeSidebar() {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }

            if (menuOpenBtn) menuOpenBtn.addEventListener('click', openSidebar);
            if (menuCloseBtn) menuCloseBtn.addEventListener('click', closeSidebar);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', closeSidebar);
        }
    </script>
</body>

</html>
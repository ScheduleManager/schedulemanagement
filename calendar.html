<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>L·ªãch L√†m Vi·ªác</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">

    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- T·∫£i FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/vi.global.min.js'></script>

    <!-- T·∫£i SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* --- T√ôY CH·ªàNH FULLCALENDAR --- */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-today-bg-color: #fffbeb;
            --fc-page-bg-color: #ffffff;
            --fc-neutral-bg-color: #f1f5f9;
            --fc-list-event-hover-bg-color: #f1f5f9;
        }

        .fc .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .fc .fc-button {
            border-radius: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1.25rem;
            text-transform: capitalize;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            background-color: #3b82f6;
            border-color: #3b82f6;
            transition: all 0.2s;
        }

        .fc .fc-button:hover {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        .fc-col-header-cell {
            background-color: #f8fafc;
            padding: 12px 0;
            border-bottom: 2px solid #e2e8f0;
        }

        /* FIX: ƒê·∫£m b·∫£o ti√™u ƒë·ªÅ c·ªôt lu√¥n hi·ªÉn th·ªã v√† kh√¥ng b·ªã g·∫°ch ch√¢n */
        .fc-col-header-cell-cushion {
            color: #64748b !important;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.85rem;
            text-decoration: none !important;
            display: inline-block;
        }

        /* FIX: ƒê·∫£m b·∫£o s·ªë ng√†y lu√¥n hi·ªÉn th·ªã r√µ */
        .fc-daygrid-day-number {
            color: #475569 !important;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none !important;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 4px;
            opacity: 1 !important;
        }

        .fc-day-today .fc-daygrid-day-number {
            background-color: #3b82f6;
            color: white !important;
        }

        /* Custom Event Style */
        .custom-event {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: 600;
            width: 100%;
            height: 100%;
            overflow: hidden;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.2;
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
        }

        .custom-event:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            z-index: 10;
        }

        .event-time-badge {
            font-size: 0.7rem;
            opacity: 0.9;
            white-space: nowrap;
            margin-bottom: 1px;
            font-weight: 700;
        }

        .event-title-row {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .event-icon {
            margin-right: 4px;
            font-size: 0.8rem;
        }

        .event-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-input {
            width: 100%;
            padding: 0.6rem 0.8rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s;
            background-color: #f8fafc;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:disabled {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #e2e8f0;
        }

        .hidden {
            display: none;
        }

        /* RESPONSIVE TWEAKS FOR MOBILE */
        @media (max-width: 640px) {
            .fc .fc-toolbar {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 0.5rem !important;
            }

            .fc .fc-toolbar-title {
                font-size: 1.25rem;
            }

            .fc .fc-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }

            /* Tinh ch·ªânh √¥ c√¥ng vi·ªác NH·ªé H∆†N tr√™n Mobile */
            .custom-event {
                padding: 1px 2px !important;
                font-size: 0.65rem !important;
                /* Font nh·ªè h∆°n */
                border-left-width: 2px !important;
                line-height: 1.1 !important;
            }

            .event-time-badge {
                font-size: 0.55rem !important;
                margin-bottom: 0 !important;
            }

            .event-icon {
                font-size: 0.6rem !important;
                margin-right: 2px !important;
            }

            .fc-daygrid-day-number {
                width: 24px;
                height: 24px;
                font-size: 0.85rem;
            }

            /* ·∫®n b·ªõt n√∫t tr√™n mobile n·∫øu c·∫ßn */
            .fc-header-toolbar .fc-toolbar-chunk:nth-child(3) {
                display: flex;
                gap: 4px;
            }
        }
    </style>
</head>

<body class="flex flex-col h-screen text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 z-30 shadow-sm flex-none">
        <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Left: Logo & Back Button -->
                <div class="flex items-center gap-3">
                    <button id="menuOpenButton" class="md:hidden text-gray-600 p-2 rounded hover:bg-gray-100">
                        <i class="bi bi-list text-2xl"></i>
                    </button>

                    <a href="index.html"
                        class="flex items-center justify-center bg-slate-100 hover:bg-slate-200 text-slate-600 p-2 rounded-lg transition"
                        title="Quay l·∫°i Dashboard">
                        <i class="bi bi-arrow-left text-xl"></i>
                    </a>

                    <div class="bg-blue-600 p-2 rounded-lg text-white shadow-md hidden sm:block">
                        <i class="bi bi-calendar-check-fill text-xl"></i>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight hidden sm:block">L·ªãch L√†m Vi·ªác</h1>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-3">
                    <div class="relative hidden lg:block">
                        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..."
                            class="pl-10 pr-4 py-2 bg-slate-100 border-none rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 transition">
                        <i class="bi bi-search absolute left-3.5 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    </div>

                    <div class="hidden md:block relative">
                        <select id="categoryFilterDesktop"
                            class="appearance-none pl-9 pr-8 py-2 bg-slate-100 border-none rounded-full text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer">
                            <option value="all">T·∫•t c·∫£ ph√¢n lo·∫°i</option>
                        </select>
                        <i
                            class="bi bi-funnel-fill absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500"></i>
                        <i
                            class="bi bi-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-xs text-slate-500"></i>
                    </div>

                    <button onclick="openModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm font-medium shadow-md transition flex items-center gap-2 transform active:scale-95">
                        <i class="bi bi-plus-lg text-lg"></i> <span class="hidden sm:inline">Th√™m m·ªõi</span>
                    </button>

                    <button onclick="exportExcel()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-full text-sm font-medium shadow-md transition flex items-center gap-2 transform active:scale-95">
                        <i class="bi bi-file-earmark-excel-fill"></i> <span class="hidden sm:inline">Xu·∫•t Excel</span>
                    </button>

                    <div id="authContainer" class="ml-2">
                        <button id="btnLogin"
                            class="hidden text-sm bg-white border border-blue-500 text-blue-500 px-3 py-1.5 rounded-full hover:bg-blue-50 transition">ƒêƒÉng
                            nh·∫≠p</button>
                        <div id="userProfile" class="hidden flex items-center gap-2">
                            <img id="userAvatar" src="" class="w-8 h-8 rounded-full border border-slate-300"
                                alt="Avatar">
                            <button id="btnLogout" class="text-xs text-red-500 hover:underline">Tho√°t</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-2 sm:p-4 bg-slate-50 overflow-y-auto flex flex-col">
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-sm border border-slate-200 flex-1 p-2 sm:p-4 relative">
            <div id="calendar"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-slate-200 py-4 flex-none">
        <div class="container mx-auto px-4 text-center text-slate-500 text-sm">
            <div class="mb-1">
                <span class="font-bold text-slate-800">Qu·∫£n L√Ω C√¥ng Vi·ªác</span> &copy; 2025
            </div>
            <div>
                Thi·∫øt k·∫ø & Ph√°t tri·ªÉn v·ªõi <i class="bi bi-heart-fill text-red-500 mx-1"></i> cho hi·ªáu su·∫•t t·ªëi ∆∞u.
            </div>
        </div>
    </footer>

    <!-- Modal Form -->
    <div id="taskModal" class="fixed inset-0 z-50 hidden transition-opacity duration-300">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal()"></div>

        <div
            class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[95%] sm:w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden scale-100 transition-transform duration-300 max-h-[95vh] flex flex-col">
            <!-- Header -->
            <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center bg-white flex-none">
                <h3 class="text-lg font-bold text-slate-800" id="modalTitle">C√¥ng vi·ªác m·ªõi</h3>
                <button onclick="closeModal()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400 hover:text-slate-600 transition">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="p-4 sm:p-5 space-y-3 overflow-y-auto flex-1">
                <form id="taskForm" onsubmit="saveTask(event)">
                    <input type="hidden" id="taskId">

                    <!-- Row 1: T√™n + Tr·∫°ng th√°i -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                        <div class="sm:col-span-2">
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">T√™n c√¥ng vi·ªác <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="taskName" required placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác..."
                                class="form-input">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Tr·∫°ng th√°i</label>
                            <select id="taskStatus" class="form-input cursor-pointer">
                                <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                                <option value="Ch∆∞a th·ª±c hi·ªán">Ch∆∞a th·ª±c hi·ªán</option>
                                <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                            </select>
                        </div>
                    </div>

                    <!-- Row 2: Danh m·ª•c -->
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Danh m·ª•c</label>
                        <select id="taskCategory" class="form-input cursor-pointer"
                            onchange="toggleCustomCategory(this)">
                            <!-- JS populated -->
                        </select>
                        <input type="text" id="customCategoryInput" class="form-input mt-2 hidden"
                            placeholder="Nh·∫≠p t√™n danh m·ª•c m·ªõi">
                    </div>

                    <!-- Row 3: Ng√†y b·∫Øt ƒë·∫ßu + Th·ªùi l∆∞·ª£ng + Deadline -->
                    <div class="grid grid-cols-3 gap-2 sm:gap-4 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <div class="col-span-3 sm:col-span-1">
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <input type="date" id="taskStartDate" required class="form-input"
                                onchange="calculateDeadline()">
                        </div>
                        <div class="col-span-1.5 sm:col-span-1">
                            <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Th·ªùi l∆∞·ª£ng
                                (Ng√†y)</label>
                            <!-- Y√äU C·∫¶U: CH·ªà NH·∫¨P S·ªê NGUY√äN (KH√îNG S·ªê L·∫∫, KH√îNG D·∫§U CH·∫§M) -->
                            <input type="number" id="taskDuration" value="1" min="0" step="1" class="form-input"
                                onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                oninput="this.value = this.value.replace(/[^0-9]/g, ''); calculateDeadline()">
                        </div>
                        <div class="col-span-1.5 sm:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">H·∫°n cu·ªëi (Auto)</label>
                            <input type="date" id="taskDeadline" disabled
                                class="form-input bg-white text-slate-500 font-bold border-slate-200">
                        </div>
                    </div>

                    <!-- Row 4: Chi ti·∫øt gi·ªù (T√çNH NƒÇNG M·ªöI) -->
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-700 mb-2 flex items-center gap-2 uppercase">
                            <i class="bi bi-clock"></i> Chi ti·∫øt th·ªùi gian trong ng√†y
                        </h4>
                        <div class="flex flex-wrap sm:flex-nowrap items-center gap-2 sm:gap-4">
                            <div class="flex-1 min-w-[100px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Gi·ªù b·∫Øt
                                    ƒë·∫ßu</label>
                                <input type="time" id="taskStartTime" class="form-input text-sm"
                                    onchange="calculateHours()">
                            </div>
                            <span class="text-slate-400 font-bold mt-4 hidden sm:inline">-</span>
                            <div class="flex-1 min-w-[100px]">
                                <label class="block text-[10px] font-bold text-slate-500 mb-1 uppercase">Gi·ªù k·∫øt
                                    th√∫c</label>
                                <input type="time" id="taskEndTime" class="form-input text-sm"
                                    onchange="calculateHours()">
                            </div>
                            <!-- HI·ªÇN TH·ªä K·∫æT QU·∫¢ T√çNH TO√ÅN -->
                            <div id="hourDurationText"
                                class="text-xs text-blue-600 font-bold w-full sm:w-auto text-left sm:text-right mt-2 sm:mt-4">
                            </div>
                        </div>
                    </div>

                    <!-- Row 5: Ghi ch√∫ -->
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1 uppercase">Ghi ch√∫</label>
                        <textarea id="taskNote" rows="2" placeholder="Ghi ch√∫ th√™m..."
                            class="form-input resize-none"></textarea>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="px-5 py-3 border-t border-slate-100 bg-gray-50 flex justify-between items-center flex-none">
                <button type="button" id="deleteBtn" onclick="deleteTask()"
                    class="hidden text-red-600 hover:text-red-700 text-sm font-bold px-3 py-2 rounded hover:bg-red-50 transition flex items-center gap-2">
                    <i class="bi bi-trash"></i> <span class="hidden sm:inline">X√≥a</span>
                </button>
                <div class="flex gap-3 ml-auto">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 text-sm font-bold transition">H·ªßy</button>
                    <!-- Th√™m ID cho n√∫t L∆∞u ƒë·ªÉ d·ªÖ d√†ng ·∫©n hi·ªán -->
                    <button type="button" id="saveBtn"
                        onclick="document.getElementById('taskForm').dispatchEvent(new Event('submit'))"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-bold shadow-md transition">L∆∞u
                        l·∫°i</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Mobile -->
    <div id="sidebarOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity"></div>
    <div id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-72 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h2 class="text-lg font-bold text-gray-800"><i class="bi bi-menu-button-wide mr-2"></i>Menu</h2>
            <button id="menuCloseButton" class="text-gray-500 hover:text-red-500 transition"><i
                    class="bi bi-x-lg text-xl"></i></button>
        </div>
        <div class="p-4 flex flex-col gap-4 overflow-y-auto">
            <a href="index.html"
                class="flex items-center gap-3 p-3 bg-slate-100 hover:bg-slate-200 rounded-lg transition text-slate-700 font-medium"><i
                    class="bi bi-house-door-fill text-lg"></i> V·ªÅ Dashboard</a>
            <hr class="border-gray-200">
            <button onclick="exportExcel()"
                class="w-full py-2 px-3 text-left text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition"><i
                    class="bi bi-file-earmark-excel mr-2 text-green-600"></i> Xu·∫•t Excel</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-6 right-6 bg-slate-800 text-white px-5 py-3 rounded-xl shadow-2xl transform translate-y-24 opacity-0 transition-all duration-300 z-[60] flex items-center gap-3">
        <div class="bg-green-500 rounded-full p-1"><i class="bi bi-check text-white text-sm"></i></div>
        <span id="toastMsg" class="font-medium text-sm">Th√†nh c√¥ng</span>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDILs6zPfC0UdPL7crGbAot-w2vt5eCGgk",
            authDomain: "flutter-ai-playground-c65f3.firebaseapp.com",
            projectId: "flutter-ai-playground-c65f3",
            storageBucket: "flutter-ai-playground-c65f3.appspot.com",
            messagingSenderId: "932092331324",
            appId: "1:932092331324:web:dcbb33b44b5d55a43cca39"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let unsubscribeSnapshot = null;

        const btnLogin = document.getElementById('btnLogin');
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const btnLogout = document.getElementById('btnLogout');

        if (btnLogin) btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(e => showToast(e.message, true)));
        if (btnLogout) btnLogout.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, user => {
            currentUser = user;

            if (unsubscribeSnapshot) {
                unsubscribeSnapshot();
                unsubscribeSnapshot = null;
                window.tasks = [];
                if (window.calendar) window.calendar.refetchEvents();
            }

            if (user) {
                btnLogin.classList.add('hidden');
                userProfile.classList.remove('hidden');
                userAvatar.src = user.photoURL;

                const q = query(collection(db, "users", user.uid, "tasks"), orderBy("deadline"));

                unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
                    window.tasks = snapshot.docs.map(doc => {
                        const data = doc.data();
                        return { id: doc.id, ...data };
                    });

                    // Sync categories
                    const dynamicCats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
                    window.tasks.forEach(t => { if (t.category) dynamicCats.add(t.category); });
                    if (window.updateFilterDropdown) window.updateFilterDropdown(dynamicCats);
                    if (window.updateModalDropdown) window.updateModalDropdown(dynamicCats);

                    if (window.calendar) window.calendar.refetchEvents();
                });
            } else {
                btnLogin.classList.remove('hidden');
                userProfile.classList.add('hidden');
            }
        });

        window.dbActions = {
            add: async (data) => {
                if (!currentUser) return alert("C·∫ßn ƒëƒÉng nh·∫≠p");
                await addDoc(collection(db, "users", currentUser.uid, "tasks"), { ...data, createdAt: serverTimestamp() });
            },
            update: async (id, data) => {
                if (!currentUser) return alert("C·∫ßn ƒëƒÉng nh·∫≠p");
                await updateDoc(doc(db, "users", currentUser.uid, "tasks", id), data);
            },
            delete: async (id) => {
                if (!currentUser) return alert("C·∫ßn ƒëƒÉng nh·∫≠p");
                await deleteDoc(doc(db, "users", currentUser.uid, "tasks", id));
            }
        };
    </script>

    <!-- MAIN APP LOGIC -->
    <script>
        const CATEGORIES = [
            { id: 'Gi·∫£ng d·∫°y', name: 'Gi·∫£ng d·∫°y', color: '#0d6efd' },
            { id: 'H·ªçp', name: 'H·ªçp', color: '#fd7e14' },
            { id: 'Coi thi', name: 'Coi thi', color: '#dc3545' },
            { id: 'Vi·ªác c√° nh√¢n', name: 'Vi·ªác c√° nh√¢n', color: '#64748b' }
        ];

        function getCategoryColor(catName) {
            const baseColors = {
                'Gi·∫£ng d·∫°y': '#0d6efd',
                'H·ªçp': '#fd7e14',
                'Coi thi': '#dc3545',
                'Vi·ªác c√° nh√¢n': '#64748b'
            };
            if (baseColors[catName]) return baseColors[catName];
            let hash = 0;
            for (let i = 0; i < catName.length; i++) hash = catName.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash % 360)}, ${60 + (Math.abs(hash) % 20)}%, ${40 + (Math.abs(hash) % 10)}%)`;
        }

        window.calendar = null;

        document.addEventListener('DOMContentLoaded', function () {
            populateCategorySelects();
            initCalendar();
            setupSearch();
            setupSidebar();
        });

        function populateCategorySelects() {
            const formSelect = document.getElementById('taskCategory');
            const filterSelect = document.getElementById('categoryFilterDesktop');

            formSelect.innerHTML = '';

            CATEGORIES.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat.id;
                opt.innerText = cat.name;
                formSelect.appendChild(opt);

                const opt2 = document.createElement('option');
                opt2.value = cat.id;
                opt2.innerText = cat.name;
                filterSelect.appendChild(opt2);
            });

            filterSelect.addEventListener('change', () => {
                if (window.calendar) window.calendar.refetchEvents();
            });
        }

        window.updateFilterDropdown = function (categories) {
            const filterSelect = document.getElementById('categoryFilterDesktop');
            const currentVal = filterSelect.value;
            while (filterSelect.options.length > 1) filterSelect.remove(1);
            categories.forEach(cat => filterSelect.add(new Option(cat, cat)));
            if (Array.from(filterSelect.options).some(o => o.value === currentVal)) filterSelect.value = currentVal;
        }

        window.updateModalDropdown = function (categories) {
            const modalSelect = document.getElementById('taskCategory');
            if (modalSelect.value === '__other__') return;
            const currentVal = modalSelect.value;
            modalSelect.innerHTML = '';
            categories.forEach(cat => modalSelect.add(new Option(cat, cat)));
            const otherOpt = new Option('+ Nh·∫≠p danh m·ª•c m·ªõi...', '__other__');
            otherOpt.className = "fw-bold text-primary";
            modalSelect.add(otherOpt);
            if (Array.from(modalSelect.options).some(o => o.value === currentVal)) modalSelect.value = currentVal;
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            window.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'vi',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: { today: 'H√¥m nay', month: 'Th√°ng', week: 'Tu·∫ßn', day: 'Ng√†y' },
                aspectRatio: 1.1,
                height: 'auto',
                dayMaxEvents: false,
                slotMinTime: '06:00:00',
                slotMaxTime: '22:00:00',
                allDaySlot: true,

                events: function (info, successCallback) {
                    const filterCat = document.getElementById('categoryFilterDesktop').value;
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    const allTasks = window.tasks || [];

                    let filtered = allTasks.filter(t => {
                        const matchCat = filterCat === 'all' || t.category === filterCat;
                        const matchSearch = t.name && t.name.toLowerCase().includes(searchTerm);
                        return matchCat && matchSearch;
                    });

                    successCallback(filtered.map(t => {
                        let baseDate = t.deadline;
                        let startISO = baseDate;
                        let endISO = null;
                        let isAllDay = true;

                        if (t.startTime) {
                            startISO = `${baseDate}T${t.startTime}`;
                            isAllDay = false;
                            if (t.endTime) endISO = `${baseDate}T${t.endTime}`;
                        }

                        return {
                            id: t.id,
                            title: t.name,
                            start: startISO,
                            end: endISO,
                            allDay: isAllDay,
                            extendedProps: { ...t }
                        }
                    }));
                },

                eventContent: function (arg) {
                    const props = arg.event.extendedProps;
                    const bgColor = getCategoryColor(props.category);

                    let iconHtml = '';
                    if (props.status === 'Ho√†n th√†nh') iconHtml = '<i class="bi bi-check-square-fill text-green-300 mr-1.5 text-sm"></i>';
                    else if (props.status === 'Ch∆∞a th·ª±c hi·ªán') iconHtml = '<i class="bi bi-circle mr-1.5 text-[10px] opacity-70"></i>';
                    else iconHtml = '<i class="bi bi-hourglass-split text-yellow-200 mr-1.5 text-xs"></i>';

                    let timeDisplay = '';
                    if (!arg.event.allDay && props.startTime) {
                        timeDisplay = `<div class="event-time-badge">${props.startTime}${props.endTime ? ' - ' + props.endTime : ''}</div>`;
                    }

                    const today = new Date().setHours(0, 0, 0, 0);
                    const deadline = new Date(props.deadline).setHours(0, 0, 0, 0);
                    let warningBadge = '';
                    if (props.status !== 'Ho√†n th√†nh' && deadline === today) {
                        warningBadge = '<span class="ml-auto bg-red-500 text-white text-[10px] font-bold px-1.5 rounded animate-pulse"><i class="bi bi-alarm-fill"></i></span>';
                    }

                    return {
                        html: `
                            <div class="custom-event" style="background-color: ${bgColor}; border-left: 3px solid rgba(0,0,0,0.2);">
                                ${timeDisplay}
                                <div class="event-title-row">
                                    <div class="event-icon">${iconHtml}</div>
                                    <div class="event-title flex-1">${arg.event.title}</div>
                                    ${warningBadge}
                                </div>
                            </div>
                        `
                    };
                },

                dateClick: function (info) { openModal(null, info.dateStr); },
                eventClick: function (info) {
                    const id = info.event.id;
                    const task = (window.tasks || []).find(t => t.id === id);
                    if (task) openModal(task);
                },
                eventDrop: function (info) {
                    const id = info.event.id;
                    const newDeadline = info.event.start.toISOString().split('T')[0];
                    const task = (window.tasks || []).find(t => t.id === id);

                    if (task && window.dbActions) {
                        const duration = task.duration || 0;
                        const d = new Date(newDeadline);
                        d.setDate(d.getDate() - parseInt(duration));
                        const newStartDate = d.toISOString().split('T')[0];

                        let newStartTime = null;
                        let newEndTime = null;
                        if (!info.event.allDay && info.event.start) {
                            newStartTime = info.event.start.toTimeString().substring(0, 5);
                            if (info.event.end) {
                                newEndTime = info.event.end.toTimeString().substring(0, 5);
                            }
                        }

                        const updates = {
                            createdDate: newStartDate,
                            deadline: newDeadline
                        };

                        if (!info.event.allDay) {
                            updates.startTime = newStartTime;
                            updates.endTime = newEndTime;
                        }

                        window.dbActions.update(id, updates);
                        showToast("ƒê√£ c·∫≠p nh·∫≠t th·ªùi gian");
                    }
                }
            });
            window.calendar.render();
        }

        function addDays(dateStr, days) {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setDate(result.getDate() + parseInt(days));
            return result.toISOString().split('T')[0];
        }

        function subtractDays(dateStr, days) {
            if (!dateStr) return '';
            const result = new Date(dateStr);
            result.setDate(result.getDate() - parseInt(days));
            return result.toISOString().split('T')[0];
        }

        window.calculateDeadline = function () {
            const start = document.getElementById('taskStartDate').value;
            const dur = document.getElementById('taskDuration').value || 0;
            if (start) document.getElementById('taskDeadline').value = addDays(start, dur);
        }

        // T√çNH GI·ªú T·ª∞ ƒê·ªòNG
        window.calculateHours = function () {
            const start = document.getElementById('taskStartTime').value;
            const end = document.getElementById('taskEndTime').value;
            const output = document.getElementById('hourDurationText');

            if (start && end) {
                const s = new Date("1970-01-01 " + start);
                const e = new Date("1970-01-01 " + end);
                let diffMs = e - s;
                if (diffMs < 0) {
                    output.innerText = "Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu";
                    output.classList.add('text-red-500');
                    return;
                }
                output.classList.remove('text-red-500');
                const diffHrs = Math.floor((diffMs % 86400000) / 3600000);
                const diffMins = Math.round(((diffMs % 86400000) % 3600000) / 60000);

                let durationStr = "";
                if (diffHrs > 0) durationStr += `${diffHrs} ti·∫øng `;
                if (diffMins > 0) durationStr += `${diffMins} ph√∫t`;
                if (diffHrs === 0 && diffMins === 0) durationStr = "0 ph√∫t";

                output.innerText = `Th·ªùi l∆∞·ª£ng: ${durationStr}`;
            } else {
                output.innerText = "";
            }
        }

        window.toggleCustomCategory = function (select) {
            const input = document.getElementById('customCategoryInput');
            if (select.value === '__other__') {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        }

        function openModal(task = null, dateStr = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const title = document.getElementById('modalTitle');
            const deleteBtn = document.getElementById('deleteBtn');
            const saveBtn = document.getElementById('saveBtn'); // N√∫t L∆∞u
            const customInput = document.getElementById('customCategoryInput');
            const formElements = form.querySelectorAll('input, select, textarea');

            form.reset();
            customInput.classList.add('hidden');
            document.getElementById('hourDurationText').innerText = "";

            const dynamicCats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
            if (window.tasks) window.tasks.forEach(t => { if (t.category) dynamicCats.add(t.category); });
            updateModalDropdown(dynamicCats);

            if (task) {
                // KI·ªÇM TRA TR·∫†NG TH√ÅI "HO√ÄN TH√ÄNH"
                const isCompleted = task.status === 'Ho√†n th√†nh';

                title.innerText = isCompleted ? 'Chi ti·∫øt c√¥ng vi·ªác (ƒê√£ ho√†n th√†nh)' : 'C·∫≠p nh·∫≠t c√¥ng vi·ªác';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;

                const catSelect = document.getElementById('taskCategory');
                if ([...catSelect.options].some(o => o.value === task.category)) {
                    catSelect.value = task.category;
                } else {
                    catSelect.value = '__other__';
                    customInput.value = task.category;
                    if (!isCompleted) customInput.classList.remove('hidden');
                }

                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskStartDate').value = task.createdDate || '';
                document.getElementById('taskDuration').value = task.duration || 0;
                document.getElementById('taskDeadline').value = task.deadline || '';

                document.getElementById('taskStartTime').value = task.startTime || '';
                document.getElementById('taskEndTime').value = task.endTime || '';
                calculateHours();

                document.getElementById('taskNote').value = task.note || '';

                // LOGIC V√î HI·ªÜU H√ìA FORM N·∫æU HO√ÄN TH√ÄNH
                if (isCompleted) {
                    formElements.forEach(el => el.disabled = true);
                    saveBtn.classList.add('hidden'); // ·∫®n n√∫t L∆∞u
                    deleteBtn.classList.remove('hidden'); // Hi·ªán n√∫t X√≥a
                } else {
                    formElements.forEach(el => {
                        // Tr·ª´ √¥ Deadline (lu√¥n auto) th√¨ enable l·∫°i
                        if (el.id !== 'taskDeadline') el.disabled = false;
                    });
                    saveBtn.classList.remove('hidden');
                    deleteBtn.classList.remove('hidden');
                }

            } else {
                // MODE: TH√äM M·ªöI (Lu√¥n cho ph√©p nh·∫≠p)
                title.innerText = 'Th√™m c√¥ng vi·ªác m·ªõi';
                document.getElementById('taskId').value = '';

                // Reset enable all
                formElements.forEach(el => {
                    if (el.id !== 'taskDeadline') el.disabled = false;
                });
                saveBtn.classList.remove('hidden');

                const defaultDuration = 1;
                let startDate, deadlineDate;
                let startTime = '';

                if (dateStr) {
                    if (dateStr.includes('T')) {
                        const parts = dateStr.split('T');
                        deadlineDate = parts[0];
                        startDate = subtractDays(deadlineDate, defaultDuration);
                        startTime = parts[1].substring(0, 5);
                    } else {
                        deadlineDate = dateStr;
                        startDate = subtractDays(deadlineDate, defaultDuration);
                        const now = new Date();
                        const currentHour = now.getHours();
                        startTime = (currentHour + 1).toString().padStart(2, '0') + ":00";
                    }
                } else {
                    startDate = new Date().toISOString().split('T')[0];
                    deadlineDate = addDays(startDate, defaultDuration);
                    const now = new Date();
                    const currentHour = now.getHours();
                    startTime = (currentHour + 1).toString().padStart(2, '0') + ":00";
                }

                document.getElementById('taskStartDate').value = startDate;
                document.getElementById('taskDuration').value = defaultDuration;
                document.getElementById('taskDeadline').value = deadlineDate;

                document.getElementById('taskStartTime').value = startTime;
                if (startTime) {
                    const [h, m] = startTime.split(':').map(Number);
                    const endH = (h + 1) % 24;
                    document.getElementById('taskEndTime').value = endH.toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');
                }
                calculateHours();

                document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                document.getElementById('taskStatus').value = 'ƒêang th·ª±c hi·ªán';
                deleteBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        window.closeModal = function () {
            document.getElementById('taskModal').classList.add('hidden');
        }

        window.saveTask = async function (e) {
            e.preventDefault();
            const id = document.getElementById('taskId').value;

            const startDate = document.getElementById('taskStartDate').value;
            // √âP KI·ªÇU S·ªê NGUY√äN (INT)
            let duration = parseInt(document.getElementById('taskDuration').value) || 0;
            const status = document.getElementById('taskStatus').value;

            let priority = 'Trung b√¨nh';
            if (status === 'Ch∆∞a th·ª±c hi·ªán' || status === 'Ho√†n th√†nh') {
                priority = 'Th·∫•p';
                if (status === 'Ho√†n th√†nh') duration = 0;
            } else {
                const deadlineCheck = addDays(startDate, duration);
                const daysLeft = Math.ceil((new Date(deadlineCheck) - new Date().setHours(0, 0, 0, 0)) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 3) priority = 'Cao';
                else if (daysLeft >= 10) priority = 'Th·∫•p';
            }

            const deadline = addDays(startDate, duration);

            let category = document.getElementById('taskCategory').value;
            if (category === '__other__') {
                category = document.getElementById('customCategoryInput').value.trim();
                if (!category) return alert("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c m·ªõi");
            }

            const taskData = {
                name: document.getElementById('taskName').value,
                category: category,
                status: status,
                priority: priority,
                createdDate: startDate,
                duration: duration,
                deadline: deadline,
                startTime: document.getElementById('taskStartTime').value,
                endTime: document.getElementById('taskEndTime').value,
                note: document.getElementById('taskNote').value
            };

            try {
                if (window.dbActions) {
                    if (id) {
                        await window.dbActions.update(id, taskData);
                        showToast("ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    } else {
                        await window.dbActions.add(taskData);
                        showToast("ƒê√£ th√™m c√¥ng vi·ªác m·ªõi!");
                    }

                    if (document.getElementById('taskCategory').value === '__other__') {
                        document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                        document.getElementById('customCategoryInput').classList.add('hidden');
                    }
                    closeModal();
                } else {
                    alert("Ch∆∞a k·∫øt n·ªëi DB");
                }
            } catch (err) {
                console.error(err);
                showToast("L·ªói: " + err.message, true);
            }
        }

        window.deleteTask = async function () {
            const id = document.getElementById('taskId').value;
            if (id && confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?')) {
                try {
                    await window.dbActions.delete(id);
                    showToast("ƒê√£ x√≥a c√¥ng vi·ªác!");
                    closeModal();
                } catch (e) {
                    showToast("L·ªói x√≥a: " + e.message, true);
                }
            }
        }

        function showToast(msg, isError = false) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            if (isError) toast.querySelector('div').classList.replace('bg-green-500', 'bg-red-500');
            else toast.querySelector('div').classList.replace('bg-red-500', 'bg-green-500');

            toast.classList.remove('translate-y-24', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-24', 'opacity-0'), 3000);
        }

        window.exportExcel = function () {
            const allTasks = window.tasks || [];
            if (allTasks.length === 0) return showToast("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t", true);

            const ws = XLSX.utils.json_to_sheet(allTasks);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CongViec");
            XLSX.writeFile(wb, "LichLamViec.xlsx");
        }

        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', () => {
                if (window.calendar) window.calendar.refetchEvents();
            });
        }

        function setupSidebar() {
            const menuOpenBtn = document.getElementById('menuOpenButton');
            const menuCloseBtn = document.getElementById('menuCloseButton');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (menuOpenBtn) menuOpenBtn.addEventListener('click', () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            });
            const close = () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            };
            if (menuCloseBtn) menuCloseBtn.addEventListener('click', close);
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', close);
        }
    </script>
</body>

</html>
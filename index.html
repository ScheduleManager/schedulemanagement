<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω C√¥ng Vi·ªác - Pro</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <!-- CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px;
        }

        .header-custom {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .card-stat {
            transition: all 0.3s ease;
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .card-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .table-custom th {
            background-color: #f1f5f9;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            color: #64748b;
            white-space: nowrap;
        }

        .editable-cell {
            position: relative;
            transition: background-color 0.2s;
        }

        .editable-cell:not(.locked) {
            cursor: pointer;
        }

        .editable-cell:not(.locked):hover {
            background-color: #eef2ff !important;
        }

        .editable-cell:not(.locked):hover::after {
            content: '\f4cb';
            font-family: 'bootstrap-icons';
            position: absolute;
            right: 8px;
            font-size: 0.8rem;
            color: #3b82f6;
            opacity: 0.5;
        }

        .editable-cell.locked {
            cursor: not-allowed;
            color: #999;
            background-color: #f8f9fa;
        }

        .page-link {
            border: none;
            color: #64748b;
            margin: 0 2px;
            border-radius: 8px !important;
            cursor: pointer;
        }

        .page-item.active .page-link {
            background-color: #0d6efd;
            color: white;
        }

        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -1px 3px 0 rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .notification-item {
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background-color: #eef2ff;
        }

        /* Custom Legend Style for Charts */
        .chart-legend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #4b5563;
            padding: 6px 0;
            border-bottom: 1px dashed #f3f4f6;
        }

        .chart-legend-item:last-child {
            border-bottom: none;
        }

        .legend-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .legend-value {
            font-weight: 700;
            color: #1f2937;
        }

        /* Modal Customization matches screenshot */
        .modal-header.bg-primary {
            background-color: #0d6efd !important;
        }

        .modal-title {
            font-size: 1.1rem;
        }
    </style>
</head>

<body>

    <!-- HEADER -->
    <header class="header-custom bg-white sticky-top z-50">
        <div class="container py-3">
            <nav class="d-flex justify-content-between align-items-center gap-4">
                <div class="d-flex align-items-center gap-2">
                    <div class="bg-primary bg-opacity-10 p-2 rounded-lg text-primary"><i
                            class="bi bi-kanban-fill fs-5"></i></div>
                    <h1 class="h5 fw-bold mb-0 text-gray-800 d-none d-sm-block">Qu·∫£n L√Ω C√¥ng Vi·ªác</h1>
                </div>

                <!-- Search -->
                <div class="flex-grow-1 mx-3 d-none d-md-block" style="max-width: 400px;">
                    <div class="input-group">
                        <span class="input-group-text bg-gray-50 border-e-0"><i
                                class="bi bi-search text-muted"></i></span>
                        <input type="text" id="searchInput" class="form-control border-s-0 shadow-none"
                            placeholder="T√¨m ki·∫øm c√¥ng vi·ªác...">
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <a href="calendar.html"
                        class="btn btn-outline-secondary d-flex align-items-center gap-2 px-3 py-2 shadow-sm rounded-pill text-decoration-none"
                        title="Xem l·ªãch l√†m vi·ªác">
                        <i class="bi bi-calendar-check"></i>
                        <span class="d-none d-md-inline">Xem L·ªãch</span>
                    </a>

                    <button type="button"
                        class="btn btn-primary d-flex align-items-center gap-2 px-3 py-2 shadow-sm rounded-pill"
                        onclick="openTaskModal()">
                        <i class="bi bi-plus-circle-fill"></i> <span class="d-none d-sm-inline">Th√™m Vi·ªác</span>
                    </button>

                    <div class="dropdown">
                        <button class="btn btn-light rounded-circle p-2 position-relative" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-bell-fill fs-5 text-gray-600"></i>
                            <span id="notifyBadge"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                                style="display: none;">0</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0"
                            style="width: 340px; max-height: 400px; overflow-y: auto;">
                            <li>
                                <h6 class="dropdown-header fw-bold text-uppercase text-danger bg-light py-2">‚ö†Ô∏è C·∫ßn x·ª≠
                                    l√Ω g·∫•p (∆Øu ti√™n Cao)</h6>
                            </li>
                            <div id="notificationList"></div>
                        </ul>
                    </div>

                    <div id="authSection">
                        <button id="btnLogin" class="btn btn-outline-primary rounded-pill px-3"><i
                                class="bi bi-google me-2"></i>ƒêƒÉng nh·∫≠p</button>
                        <div id="userProfile" class="d-none dropdown">
                            <a href="#" class="d-flex align-items-center text-decoration-none"
                                data-bs-toggle="dropdown">
                                <img id="userAvatar" src="" class="rounded-circle border border-2 border-primary"
                                    style="width: 40px; height: 40px;">
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm mt-2">
                                <li><a id="btnLogout" class="dropdown-item text-danger" href="#"><i
                                            class="bi bi-box-arrow-right me-2"></i>ƒêƒÉng xu·∫•t</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <div class="container py-4">
        <div id="errorAlert" class="alert alert-danger d-none" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> <span id="errorMsg"></span>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
            <div class="card card-stat bg-white p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1 fw-bold text-uppercase">T·ªïng s·ªë</p>
                        <h3 class="fw-bold text-dark mb-0" id="totalTasks">0</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary"><i
                            class="bi bi-layers-fill fs-5"></i></div>
                </div>
            </div>
            <div class="card card-stat bg-white p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1 fw-bold text-uppercase">Ho√†n th√†nh</p>
                        <h3 class="fw-bold text-success mb-0" id="completedTasks">0</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 p-2 rounded-3 text-success"><i
                            class="bi bi-check-circle-fill fs-5"></i></div>
                </div>
            </div>
            <div class="card card-stat bg-white p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1 fw-bold text-uppercase">ƒêang th·ª±c hi·ªán</p>
                        <h3 class="fw-bold text-primary mb-0" id="inProgressTasks">0</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary"><i
                            class="bi bi-hourglass-split fs-5"></i></div>
                </div>
            </div>
            <div class="card card-stat bg-white p-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <p class="text-muted small mb-1 fw-bold text-uppercase">Ch∆∞a th·ª±c hi·ªán</p>
                        <h3 class="fw-bold text-danger mb-0" id="overdueTasks">0</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 p-2 rounded-3 text-danger"><i
                            class="bi bi-x-circle-fill fs-5"></i></div>
                </div>
            </div>
        </div>

        <!-- Charts Section (UPDATED LAYOUT FOR LEGEND) -->
        <div class="row g-4 mb-5">
            <!-- Ph√¢n b·ªï Danh m·ª•c -->
            <div class="col-lg-4">
                <div class="card chart-card p-4 h-100">
                    <h5 class="card-title fw-bold mb-4 d-flex align-items-center gap-2">
                        <i class="bi bi-pie-chart-fill text-primary"></i> Ph√¢n b·ªï Danh m·ª•c
                    </h5>
                    <!-- Chart Container -->
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-3"
                        style="min-height: 200px;">
                        <div style="height: 200px; width: 200px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <!-- Custom Legend Container -->
                    <div id="categoryLegend" class="mt-auto">
                        <!-- Legend items will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- T√¨nh tr·∫°ng C√¥ng vi·ªác -->
            <div class="col-lg-4">
                <div class="card chart-card p-4 h-100">
                    <h5 class="card-title fw-bold mb-4 d-flex align-items-center gap-2">
                        <i class="bi bi-activity text-success"></i> T√¨nh tr·∫°ng C√¥ng vi·ªác
                    </h5>
                    <!-- Chart Container -->
                    <div class="flex-grow-1 d-flex align-items-center justify-content-center mb-3"
                        style="min-height: 200px;">
                        <div style="height: 200px; width: 200px;">
                            <canvas id="completionChart"></canvas>
                        </div>
                    </div>
                    <!-- Custom Legend Container -->
                    <div id="completionLegend" class="mt-auto">
                        <!-- Legend items will be injected here by JS -->
                    </div>
                </div>
            </div>

            <!-- Kh·ªëi l∆∞·ª£ng (Tu·∫ßn) -->
            <div class="col-lg-4">
                <div class="card chart-card p-4 h-100">
                    <h5 class="card-title fw-bold mb-4 d-flex align-items-center gap-2">
                        <i class="bi bi-bar-chart-fill text-info"></i> Kh·ªëi l∆∞·ª£ng (Tu·∫ßn)
                    </h5>
                    <div class="flex-grow-1 position-relative" style="min-height: 250px;">
                        <canvas id="workloadChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Table -->
        <div class="card border-0 shadow-lg rounded-3 overflow-hidden mb-5">
            <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
                <h5 class="mb-0 fw-bold text-gray-800"><i class="bi bi-table text-primary me-2"></i>Danh s√°ch c√¥ng vi·ªác
                </h5>
                <div class="d-flex gap-2">
                    <select id="filterStatus" class="form-select form-select-sm" style="width: auto;">
                        <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                        <option value="urgent" class="fw-bold text-danger">‚ö†Ô∏è C·∫ßn x·ª≠ l√Ω g·∫•p (∆Øu ti√™n Cao)</option>
                        <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                        <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                        <option value="Ch∆∞a th·ª±c hi·ªán">Ch∆∞a th·ª±c hi·ªán</option>
                    </select>
                    <select id="filterCategory" class="form-select form-select-sm" style="width: auto;">
                        <option value="all">T·∫•t c·∫£ danh m·ª•c</option>
                    </select>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-custom align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">T√™n c√¥ng vi·ªác</th>
                            <th>Danh m·ª•c</th>
                            <th>∆Øu ti√™n</th>
                            <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                            <th>Th·ªùi l∆∞·ª£ng</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>H·∫°n cu·ªëi</th>
                            <th>C√≤n l·∫°i</th>
                            <th>Ghi ch√∫</th>
                            <th class="text-end pe-4">Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                        <tr>
                            <td colspan="10" class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary" role="status"></div>
                                <div class="mt-2">ƒêang k·∫øt n·ªëi Database...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card-footer bg-white py-3 d-flex justify-content-between align-items-center">
                <div class="small text-muted" id="paginationInfo">...</div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginationControls"></ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT TASK -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white border-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Th√™m C√¥ng Vi·ªác M·ªõi</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="addTaskForm">
                        <input type="hidden" id="editTaskId">

                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary small text-uppercase">T√™n c√¥ng vi·ªác</label>
                            <input type="text" class="form-control" id="taskName" required
                                placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác...">
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-secondary small text-uppercase">Danh m·ª•c</label>
                                <select class="form-select" id="taskCategory" onchange="toggleCustomCategory(this)">
                                    <option value="__other__" class="fw-bold text-primary">+ Nh·∫≠p danh m·ª•c m·ªõi...
                                    </option>
                                </select>
                                <input type="text" class="form-control mt-2 d-none" id="customCategoryInput"
                                    placeholder="Nh·∫≠p t√™n danh m·ª•c m·ªõi">
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-secondary small text-uppercase">Tr·∫°ng th√°i</label>
                                <select class="form-select" id="taskStatus">
                                    <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
                                    <option value="Ch∆∞a th·ª±c hi·ªán">Ch∆∞a th·ª±c hi·ªán</option>
                                    <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-secondary small text-uppercase">Ng√†y b·∫Øt
                                    ƒë·∫ßu</label>
                                <input type="date" class="form-control" id="taskStartDate" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label fw-bold text-secondary small text-uppercase">Th·ªùi l∆∞·ª£ng
                                    (Ng√†y)</label>
                                <input type="number" class="form-control" id="taskDuration" placeholder="VD: 1"
                                    value="1" min="0">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary small text-uppercase">Ghi ch√∫</label>
                            <textarea class="form-control" id="taskNote" rows="3"
                                placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4">
                    <button type="button" class="btn btn-secondary px-4 fw-bold" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="handleTaskSubmit()"
                        id="saveTaskBtn">L∆∞u c√¥ng vi·ªác</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: VIEW DETAILS -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary fs-5 d-flex align-items-center gap-2">
                        <i class="bi bi-info-circle-fill"></i> Chi Ti·∫øt C√¥ng Vi·ªác
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body pt-3 pb-4 px-4">
                    <h4 class="fw-bold text-dark mb-3" id="viewTaskName" style="font-size: 1.25rem;">T√™n c√¥ng vi·ªác</h4>
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        <span id="viewTaskCategory" class="badge rounded-pill" style="font-size: 0.85rem;">Danh
                            m·ª•c</span>
                        <span id="viewTaskPriority" class="badge rounded-pill text-dark border"
                            style="font-size: 0.85rem; background-color: #ffc107;">∆Øu ti√™n</span>
                        <span id="viewTaskStatus" class="badge rounded-pill text-white"
                            style="font-size: 0.85rem;">Tr·∫°ng th√°i</span>
                    </div>
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <label class="fw-bold text-secondary small text-uppercase mb-1"
                                style="font-size: 0.75rem;">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <div class="fw-bold text-dark fs-6" id="viewTaskStartDate">...</div>
                        </div>
                        <div class="col-6">
                            <label class="fw-bold text-secondary small text-uppercase mb-1"
                                style="font-size: 0.75rem;">H·∫°n ch√≥t</label>
                            <div class="fw-bold text-danger fs-6" id="viewTaskDeadline">...</div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="fw-bold text-secondary small text-uppercase mb-1" style="font-size: 0.75rem;">Ghi
                            ch√∫</label>
                        <div class="bg-light p-3 rounded text-secondary fst-italic border" id="viewTaskNote"
                            style="min-height: 60px;">Kh√¥ng c√≥ ghi ch√∫.</div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-secondary px-4 fw-bold" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CONFIRM DELETE -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body p-4 text-center">
                    <h5 class="fw-bold mb-2">X√°c nh·∫≠n x√≥a?</h5>
                    <p class="text-muted">H√†nh ƒë·ªông n√†y s·∫Ω x√≥a d·ªØ li·ªáu kh·ªèi Database vƒ©nh vi·ªÖn.</p>
                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button class="btn btn-light" data-bs-dismiss="modal">H·ªßy</button>
                        <button class="btn btn-danger" id="confirmDeleteBtn">X√≥a ngay</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000;">
        <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMsg">Hello</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDILs6zPfC0UdPL7crGbAot-w2vt5eCGgk",
            authDomain: "flutter-ai-playground-c65f3.firebaseapp.com",
            projectId: "flutter-ai-playground-c65f3",
            storageBucket: "flutter-ai-playground-c65f3.appspot.com",
            messagingSenderId: "932092331324",
            appId: "1:932092331324:web:dcbb33b44b5d55a43cca39"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();

            const btnLogin = document.getElementById('btnLogin');
            const userProfile = document.getElementById('userProfile');

            if (btnLogin) btnLogin.addEventListener('click', () => signInWithPopup(auth, provider).catch(e => showToast(e.message, 'danger')));
            if (document.getElementById('btnLogout')) document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));

            onAuthStateChanged(auth, user => {
                if (user) {
                    if (btnLogin) btnLogin.classList.add('d-none');
                    if (userProfile) userProfile.classList.remove('d-none');
                    if (document.getElementById('userAvatar')) document.getElementById('userAvatar').src = user.photoURL;
                } else {
                    if (btnLogin) btnLogin.classList.remove('d-none');
                    if (userProfile) userProfile.classList.add('d-none');
                }
            });

            window.tasks = [];
            const q = query(collection(db, "tasks"), orderBy("deadline"));

            onSnapshot(q, (snapshot) => {
                const loadedTasks = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const deadline = new Date(data.deadline);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    deadline.setHours(0, 0, 0, 0);
                    const diffTime = deadline - today;
                    const daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    let priority = 'Trung b√¨nh';
                    if (data.status === 'Ch∆∞a th·ª±c hi·ªán' || data.status === 'Ho√†n th√†nh') {
                        priority = 'Th·∫•p';
                    } else {
                        if (daysLeft <= 3) priority = 'Cao';
                        else if (daysLeft >= 10) priority = 'Th·∫•p';
                    }

                    return { id: doc.id, ...data, daysLeft: daysLeft, priority: priority };
                });

                window.tasks = loadedTasks;
                if (window.renderApp) window.renderApp();
            }, (error) => {
                console.error("L·ªói Firestore:", error);
                document.getElementById('errorAlert').classList.remove('d-none');
                let msg = "L·ªói k·∫øt n·ªëi Database: " + error.code;
                if (error.code === 'permission-denied') msg = "‚õî B·ªã ch·∫∑n quy·ªÅn truy c·∫≠p!";
                document.getElementById('errorMsg').innerText = msg;
            });

            window.dbActions = {
                add: async (data) => addDoc(collection(db, "tasks"), { ...data, createdAt: serverTimestamp() }),
                update: async (id, data) => updateDoc(doc(db, "tasks", id), data),
                delete: async (id) => deleteDoc(doc(db, "tasks", id))
            };
        } catch (err) {
            console.error("L·ªói kh·ªüi t·∫°o:", err);
        }
    </script>

    <!-- UI LOGIC -->
    <script>
        let currentPage = 1;
        const rowsPerPage = 10;
        let filteredTasks = [];

        const BASE_COLORS = {
            cat: { 'Gi·∫£ng d·∫°y': '#0d6efd', 'H·ªçp': '#fd7e14', 'Coi thi': '#dc3545', 'Vi·ªác c√° nh√¢n': '#6c757d' },
            status: { 'Ho√†n th√†nh': 'success', 'ƒêang th·ª±c hi·ªán': 'primary', 'Ch∆∞a th·ª±c hi·ªán': 'danger' },
            priority: { 'Cao': 'danger', 'Trung b√¨nh': 'warning', 'Th·∫•p': 'success' }
        };

        function getCategoryColor(catName) {
            if (BASE_COLORS.cat[catName]) return BASE_COLORS.cat[catName];
            let hash = 0;
            for (let i = 0; i < catName.length; i++) hash = catName.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash % 360)}, ${60 + (Math.abs(hash) % 20)}%, ${40 + (Math.abs(hash) % 10)}%)`;
        }

        window.renderApp = function () {
            const dynamicCats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
            if (window.tasks) window.tasks.forEach(t => { if (t.category) dynamicCats.add(t.category); });
            updateFilterDropdown(dynamicCats);
            updateModalDropdown(dynamicCats);
            applyFilters();
            updateCharts();
            updateNotifications();
        }

        function updateFilterDropdown(categories) {
            const filterSelect = document.getElementById('filterCategory');
            const currentVal = filterSelect.value;
            while (filterSelect.options.length > 1) filterSelect.remove(1);
            categories.forEach(cat => filterSelect.add(new Option(cat, cat)));
            if (Array.from(filterSelect.options).some(o => o.value === currentVal)) filterSelect.value = currentVal;
        }

        function updateModalDropdown(categories) {
            const modalSelect = document.getElementById('taskCategory');
            if (modalSelect.value === '__other__') return;
            const currentVal = modalSelect.value;
            modalSelect.innerHTML = '';
            categories.forEach(cat => modalSelect.add(new Option(cat, cat)));
            const otherOpt = new Option('+ Nh·∫≠p danh m·ª•c m·ªõi...', '__other__');
            otherOpt.className = "fw-bold text-primary";
            modalSelect.add(otherOpt);
            if (Array.from(modalSelect.options).some(o => o.value === currentVal)) modalSelect.value = currentVal;
        }

        function addDays(dateStr, days) {
            const result = new Date(dateStr);
            result.setDate(result.getDate() + parseInt(days));
            return result.toISOString().split('T')[0];
        }

        function applyFilters() {
            const stFilter = document.getElementById('filterStatus').value;
            const catFilter = document.getElementById('filterCategory').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const allTasks = window.tasks || [];
            filteredTasks = allTasks.filter(t => {
                const matchStatus = stFilter === 'all' || (stFilter === 'urgent' ? (t.priority === 'Cao' && t.status !== 'Ho√†n th√†nh') : t.status === stFilter);
                const matchCat = catFilter === 'all' || t.category === catFilter;
                const matchSearch = t.name.toLowerCase().includes(search);
                return matchStatus && matchCat && matchSearch;
            });
            const maxPage = Math.ceil(filteredTasks.length / rowsPerPage) || 1;
            if (currentPage > maxPage) currentPage = maxPage;
            renderTable();
            renderPagination();
        }

        function renderTable() {
            const tbody = document.getElementById('taskTableBody');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * rowsPerPage;
            const pageData = filteredTasks.slice(start, start + rowsPerPage);
            if (!window.tasks || window.tasks.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-5 text-muted">D·ªØ li·ªáu tr·ªëng. H√£y b·∫•m "Th√™m Vi·ªác" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</td></tr>`;
                return;
            }
            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-5 text-muted">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</td></tr>`;
                return;
            }
            pageData.forEach(t => {
                let daysBadge = '';
                const isCompleted = t.status === 'Ho√†n th√†nh';

                if (t.status === 'Ch∆∞a th·ª±c hi·ªán') daysBadge = '';
                else if (isCompleted) daysBadge = `<span class="badge rounded-pill text-bg-success">ƒê√£ xong</span>`;
                else if (t.daysLeft < 0) daysBadge = `<span class="badge rounded-pill text-bg-danger">Qu√° ${Math.abs(t.daysLeft)} ng√†y</span>`;
                else if (t.daysLeft === 0) daysBadge = `<span class="badge rounded-pill text-bg-warning text-dark">H·∫°n ch√≥t h√¥m nay</span>`;
                else daysBadge = `<span class="fw-bold text-success">C√≤n ${t.daysLeft} ng√†y</span>`;

                const tr = document.createElement('tr');
                tr.dataset.id = t.id;
                if (isCompleted) {
                    tr.classList.add('table-secondary', 'opacity-75');
                }

                const editAttr = isCompleted ? '' : `onclick="editCell(this, 'name')"`;
                const getEditAttr = (field) => isCompleted ? '' : `onclick="editCell(this, '${field}')"`;
                const getCellClass = () => `editable-cell ${isCompleted ? 'locked' : ''}`;

                tr.innerHTML = `
                    <td class="fw-bold ${getCellClass()} ps-4" ${getEditAttr('name')}>${t.name}</td>
                    <td class="${getCellClass()}" ${getEditAttr('category')}><span class="badge" style="background:${getCategoryColor(t.category)}">${t.category}</span></td>
                    <td><span class="badge text-bg-${BASE_COLORS.priority[t.priority] || 'secondary'}">${t.priority}</span></td>
                    <td class="text-muted small ${getCellClass()}" ${getEditAttr('createdDate')}>${t.createdDate || '-'}</td>
                    <td class="text-center ${getCellClass()}" ${getEditAttr('duration')}>${t.duration} ng√†y</td>
                    <td class="${getCellClass()}" ${getEditAttr('status')}><span class="badge text-bg-${BASE_COLORS.status[t.status] || 'secondary'}">${t.status}</span></td>
                    <td class="text-muted fw-bold">${t.deadline}</td>
                    <td>${daysBadge}</td>
                    <td class="text-muted small fst-italic ${getCellClass()}" ${getEditAttr('note')}>${t.note || ''}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-outline-danger btn-sm rounded-circle" onclick="confirmDelete('${t.id}')"><i class="bi bi-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.editCell = function (cell, field) {
            if (cell.classList.contains('locked') || cell.querySelector('input, select')) return;
            const row = cell.closest('tr');
            const taskId = row.dataset.id;
            const task = (window.tasks || []).find(t => t.id === taskId);
            if (!task) return;
            const oldVal = task[field];
            const oldHtml = cell.innerHTML;
            let input;
            if (field === 'status') {
                input = document.createElement('select'); input.className = 'form-select form-select-sm shadow-sm';
                Object.keys(BASE_COLORS.status).forEach(opt => input.add(new Option(opt, opt, false, opt === oldVal)));
            } else if (field === 'category') {
                input = document.createElement('select'); input.className = 'form-select form-select-sm shadow-sm';
                const cats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
                if (window.tasks) window.tasks.forEach(t => cats.add(t.category));
                cats.forEach(opt => input.add(new Option(opt, opt, false, opt === oldVal)));
            } else if (field === 'createdDate') {
                input = document.createElement('input'); input.type = 'date'; input.className = 'form-control form-control-sm'; input.value = oldVal;
            } else if (field === 'duration') {
                input = document.createElement('input'); input.type = 'number'; input.className = 'form-control form-control-sm'; input.value = oldVal || 0; input.style.width = '70px';
            } else {
                input = document.createElement('input'); input.type = 'text'; input.className = 'form-control form-control-sm'; input.value = oldVal || '';
            }
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
            const save = async () => {
                const newVal = input.value;
                if (newVal !== oldVal) {
                    try {
                        const updates = { [field]: newVal };

                        if (field === 'status' && newVal === 'Ho√†n th√†nh') {
                            updates.duration = 0;
                            updates.priority = 'Th·∫•p';
                            updates.deadline = task.createdDate;
                        } else {
                            if (field === 'duration') updates.deadline = addDays(task.createdDate, newVal);
                            if (field === 'createdDate') updates.deadline = addDays(newVal, task.duration || 0);
                        }

                        await window.dbActions.update(taskId, updates);
                        showToast('ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                    } catch (e) {
                        showToast('L·ªói c·∫≠p nh·∫≠t: ' + e.message, 'danger');
                        cell.innerHTML = oldHtml;
                    }
                } else {
                    cell.innerHTML = oldHtml;
                }
            };
            input.onblur = save;
            input.onkeydown = (e) => { if (e.key === 'Enter') { input.blur(); } };
        };

        const addTaskModalEl = document.getElementById('addTaskModal');
        const modalTitle = document.getElementById('modalTitle');
        const saveBtn = document.getElementById('saveTaskBtn');

        window.toggleCustomCategory = function (select) {
            const input = document.getElementById('customCategoryInput');
            if (select.value === '__other__') {
                input.classList.remove('d-none');
                input.focus();
            } else {
                input.classList.add('d-none');
            }
        }

        window.openTaskModal = function (taskId = null) {
            document.getElementById('addTaskForm').reset();
            document.getElementById('customCategoryInput').classList.add('d-none');
            const cats = new Set(['Gi·∫£ng d·∫°y', 'H·ªçp', 'Coi thi', 'Vi·ªác c√° nh√¢n']);
            if (window.tasks) window.tasks.forEach(t => cats.add(t.category));
            updateModalDropdown(cats);

            if (taskId) {
                const task = window.tasks.find(t => t.id === taskId);
                if (task) {
                    document.getElementById('editTaskId').value = taskId;
                    document.getElementById('taskName').value = task.name;
                    const select = document.getElementById('taskCategory');
                    if ([...select.options].some(o => o.value === task.category)) {
                        select.value = task.category;
                    } else {
                        select.value = '__other__';
                        document.getElementById('customCategoryInput').value = task.category;
                        document.getElementById('customCategoryInput').classList.remove('d-none');
                    }
                    document.getElementById('taskStatus').value = task.status;
                    document.getElementById('taskStartDate').value = task.createdDate;
                    document.getElementById('taskDuration').value = task.duration;
                    document.getElementById('taskNote').value = task.note;
                    modalTitle.innerText = "C·∫≠p Nh·∫≠t C√¥ng Vi·ªác";
                    saveBtn.innerText = "L∆∞u Thay ƒê·ªïi";
                }
            } else {
                document.getElementById('editTaskId').value = '';
                document.getElementById('taskStartDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                modalTitle.innerText = "Th√™m C√¥ng Vi·ªác M·ªõi";
                saveBtn.innerText = "Th√™m C√¥ng Vi·ªác";
            }
            bootstrap.Modal.getOrCreateInstance(addTaskModalEl).show();
        }

        const detailModalEl = document.getElementById('taskDetailModal');
        window.openTaskDetail = function (taskId) {
            const task = (window.tasks || []).find(t => t.id === taskId);
            if (!task) return;
            document.getElementById('viewTaskName').innerText = task.name;
            const catBadge = document.getElementById('viewTaskCategory');
            catBadge.innerText = task.category;
            catBadge.style.backgroundColor = getCategoryColor(task.category);
            const priBadge = document.getElementById('viewTaskPriority');
            priBadge.innerText = `∆Øu ti√™n: ${task.priority}`;
            priBadge.className = `badge rounded-pill text-bg-${BASE_COLORS.priority[task.priority] || 'secondary'}`;
            const statusBadge = document.getElementById('viewTaskStatus');
            statusBadge.innerText = task.status;
            statusBadge.className = `badge rounded-pill text-bg-${BASE_COLORS.status[task.status] || 'secondary'}`;
            document.getElementById('viewTaskStartDate').innerText = task.createdDate;
            document.getElementById('viewTaskDeadline').innerText = task.deadline;
            document.getElementById('viewTaskNote').innerText = task.note || "Kh√¥ng c√≥ ghi ch√∫.";
            bootstrap.Modal.getOrCreateInstance(detailModalEl).show();
        }

        window.handleTaskSubmit = async () => {
            const taskId = document.getElementById('editTaskId').value;
            const startDate = document.getElementById('taskStartDate').value;
            let duration = document.getElementById('taskDuration').value || 0;

            let status = document.getElementById('taskStatus').value;
            let priority = 'Trung b√¨nh';

            if (status === 'Ho√†n th√†nh') {
                duration = 0;
                priority = 'Th·∫•p';
            }

            const deadline = addDays(startDate, duration);

            let category = document.getElementById('taskCategory').value;
            if (category === '__other__') {
                category = document.getElementById('customCategoryInput').value.trim();
                if (!category) return alert("Vui l√≤ng nh·∫≠p t√™n danh m·ª•c m·ªõi");
            }

            const taskData = {
                name: document.getElementById('taskName').value,
                category: category,
                priority: priority,
                status: status,
                duration: duration,
                createdDate: startDate,
                deadline: deadline,
                note: document.getElementById('taskNote').value
            };

            if (!taskData.name) return alert("Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác");

            try {
                if (window.dbActions) {
                    if (taskId) {
                        await window.dbActions.update(taskId, taskData);
                        showToast('ƒê√£ c·∫≠p nh·∫≠t c√¥ng vi·ªác!', 'success');
                    } else {
                        await window.dbActions.add(taskData);
                        showToast('ƒê√£ th√™m c√¥ng vi·ªác m·ªõi!', 'success');
                    }

                    if (document.getElementById('taskCategory').value === '__other__') {
                        document.getElementById('taskCategory').value = 'Gi·∫£ng d·∫°y';
                        document.getElementById('customCategoryInput').classList.add('d-none');
                    }
                    const modal = bootstrap.Modal.getInstance(addTaskModalEl);
                    if (modal) modal.hide();
                } else {
                    alert("Ch∆∞a k·∫øt n·ªëi ƒë∆∞·ª£c Database.");
                }
            } catch (e) {
                showToast('L·ªói: ' + e.message, 'danger');
            }
        };

        let deleteId = null;
        const delModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        window.confirmDelete = (id) => { deleteId = id; delModal.show(); };
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if (deleteId) {
                await window.dbActions.delete(deleteId);
                delModal.hide();
                showToast('ƒê√£ x√≥a c√¥ng vi·ªác', 'success');
            }
        };

        function updateCharts() {
            const allTasks = window.tasks || [];
            if (allTasks.length === 0 && typeof tasks === 'undefined') return;
            const total = allTasks.length;
            const completed = allTasks.filter(t => t.status === 'Ho√†n th√†nh').length;
            const inProgress = allTasks.filter(t => t.status === 'ƒêang th·ª±c hi·ªán').length;
            const overdue = allTasks.filter(t => t.status === 'Ch∆∞a th·ª±c hi·ªán').length;
            document.getElementById('totalTasks').innerText = total;
            document.getElementById('completedTasks').innerText = completed;
            document.getElementById('inProgressTasks').innerText = inProgress;
            document.getElementById('overdueTasks').innerText = overdue;

            const catCounts = {};
            allTasks.forEach(t => catCounts[t.category] = (catCounts[t.category] || 0) + 1);

            if (charts.cat) {
                charts.cat.data.labels = Object.keys(catCounts);
                charts.cat.data.datasets[0].data = Object.values(catCounts);
                charts.cat.data.datasets[0].backgroundColor = Object.keys(catCounts).map(c => getCategoryColor(c));
                charts.cat.update();

                // CUSTOM LEGEND FOR CATEGORY CHART
                const legendDiv = document.getElementById('categoryLegend');
                legendDiv.innerHTML = '';
                Object.keys(catCounts).forEach(catName => {
                    const color = getCategoryColor(catName);
                    const count = catCounts[catName];

                    const item = document.createElement('div');
                    item.className = 'chart-legend-item';
                    item.innerHTML = `
                        <div class="legend-label">
                            <span class="legend-dot" style="background-color: ${color};"></span>
                            <span class="fw-medium text-dark">${catName}</span>
                        </div>
                        <span class="legend-value">${count}</span>
                    `;
                    legendDiv.appendChild(item);
                });
            }

            if (charts.status) {
                charts.status.data.datasets[0].data = [completed, inProgress, overdue];
                charts.status.update();

                // CUSTOM LEGEND FOR COMPLETION CHART
                const legendDiv = document.getElementById('completionLegend');
                legendDiv.innerHTML = '';
                const statusData = [
                    { label: 'Ho√†n th√†nh', color: '#198754', count: completed },
                    { label: 'ƒêang th·ª±c hi·ªán', color: '#0d6efd', count: inProgress },
                    { label: 'Ch∆∞a th·ª±c hi·ªán', color: '#dc3545', count: overdue }
                ];

                statusData.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'chart-legend-item';
                    div.innerHTML = `
                        <div class="legend-label">
                            <span class="legend-dot" style="background-color: ${item.color};"></span>
                            <span class="fw-medium text-dark">${item.label}</span>
                        </div>
                        <span class="legend-value">${item.count}</span>
                     `;
                    legendDiv.appendChild(div);
                });
            }

            const dayCounts = { 'T2': 0, 'T3': 0, 'T4': 0, 'T5': 0, 'T6': 0, 'T7': 0, 'CN': 0 };
            allTasks.forEach(t => {
                const day = new Date(t.deadline).getDay();
                const map = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
                if (t.status !== 'Ho√†n th√†nh') dayCounts[map[day]]++;
            });
            if (charts.work) {
                charts.work.data.datasets[0].data = Object.values(dayCounts);
                charts.work.update();
            }
        }

        function updateNotifications() {
            const urgent = (window.tasks || []).filter(t => t.priority === 'Cao' && t.status !== 'Ho√†n th√†nh').sort((a, b) => a.daysLeft - b.daysLeft);
            const badge = document.getElementById('notifyBadge');
            const list = document.getElementById('notificationList');
            badge.innerText = urgent.length;
            badge.style.display = urgent.length ? 'block' : 'none';
            list.innerHTML = '';
            if (urgent.length === 0) {
                list.innerHTML = '<li class="text-center p-3 text-muted">Kh√¥ng c√≥ vi·ªác g·∫•p</li>';
            } else {
                urgent.forEach(t => {
                    const colorClass = t.daysLeft < 0 ? 'text-danger' : 'text-warning';
                    const timeText = t.daysLeft < 0 ? `Qu√° ${Math.abs(t.daysLeft)} ng√†y` : (t.daysLeft == 0 ? 'H√¥m nay' : `C√≤n ${t.daysLeft} ng√†y`);
                    list.innerHTML += `
                        <div class="dropdown-item notification-item py-2 cursor-pointer" onclick="openTaskDetail('${t.id}')">
                            <div class="fw-bold text-dark text-truncate">${t.name}</div>
                            <div class="d-flex justify-content-between small">
                                <span class="badge bg-secondary bg-opacity-25 text-dark">${t.status}</span>
                                <span class="${colorClass} fw-bold">${timeText}</span>
                            </div>
                        </div>`;
                });
            }
        }

        function showToast(msg, type = 'primary') {
            const el = document.getElementById('liveToast');
            document.getElementById('toastMsg').innerText = msg;
            el.className = `toast align-items-center text-bg-${type} border-0`;
            new bootstrap.Toast(el).show();
        }

        function renderPagination() {
            const pages = Math.ceil(filteredTasks.length / rowsPerPage) || 1;
            const ul = document.getElementById('paginationControls');
            let html = '';
            for (let i = 1; i <= pages; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}"><button class="page-link" onclick="currentPage=${i}; renderTable()">${i}</button></li>`;
            }
            ul.innerHTML = html;
            document.getElementById('paginationInfo').innerText = `Trang ${currentPage}/${pages} (${filteredTasks.length} vi·ªác)`;
        }

        let charts = {};
        document.addEventListener('DOMContentLoaded', () => {
            Chart.defaults.font.family = "'Inter', sans-serif";
            const commonOpt = { plugins: { legend: { display: false } }, cutout: '75%', responsive: true, maintainAspectRatio: false };

            charts.cat = new Chart(document.getElementById('categoryChart'), { type: 'doughnut', data: { labels: [], datasets: [{ data: [], borderWidth: 0 }] }, options: commonOpt });
            charts.status = new Chart(document.getElementById('completionChart'), { type: 'doughnut', data: { labels: ['Xong', 'ƒêang l√†m', 'Ch∆∞a l√†m'], datasets: [{ data: [], backgroundColor: ['#198754', '#0d6efd', '#dc3545'], borderWidth: 0 }] }, options: commonOpt });

            // Workload Chart - Horizontal Bar
            charts.work = new Chart(document.getElementById('workloadChart'), {
                type: 'bar',
                data: { labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'], datasets: [{ label: 'Vi·ªác', data: [], backgroundColor: '#0dcaf0', borderRadius: 4 }] },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { color: '#f0f0f0' } },
                        y: { grid: { display: false } }
                    }
                }
            });

            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            document.getElementById('filterCategory').addEventListener('change', applyFilters);
        });
    </script>
</body>

</html>
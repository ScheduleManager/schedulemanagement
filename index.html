<!DOCTYPE html>
<!-- (M·ªöI) Th√™m class 'dark' ·ªü ƒë√¢y n·∫øu c·∫ßn, nh∆∞ng JS s·∫Ω qu·∫£n l√Ω -->
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- (M·ªöI) Title s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
    <title data-lang-key="pageTitle">Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">


    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- (M·ªöI) C·∫•u h√¨nh Tailwind cho Ch·∫ø ƒë·ªô T·ªëi -->
    <script>
        tailwind.config = {
            darkMode: 'class', // B·∫≠t ch·∫ø ƒë·ªô 'class'
            theme: {
                extend: {
                    // B·∫°n c√≥ th·ªÉ th√™m c√°c t√πy ch·ªânh kh√°c ·ªü ƒë√¢y n·∫øu mu·ªën
                }
            }
        }
    </script>

    <!-- T·∫£i FullCalendar (Th∆∞ vi·ªán L·ªãch) -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <!-- (M·ªöI) T·∫£i c√°c g√≥i ng√¥n ng·ªØ cho FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/vi.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/locales/fr.global.min.js'></script>

    <!-- T·∫£i SheetJS (Th∆∞ vi·ªán Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- (M·ªöI) T·∫£i Firebase SDK - D·∫†NG MODULE -->
    <script type="module">
        // (M·ªöI) Import th√™m c√°c h√†m X√°c th·ª±c Google
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            doc,
            addDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            query,
            where,
            getDocs,
            writeBatch,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N ---
        // (L∆∞u √Ω: ƒê√£ thay th·∫ø key b·∫±ng key m·∫´u ƒë·ªÉ b·∫£o m·∫≠t)
        const firebaseConfig = {
            apiKey: "AIzaSyDILs6zPfC0UdPL7crGbAot-w2vt5eCGgk", // S·ª≠ d·ª•ng key th·∫≠t c·ªßa b·∫°n ·ªü ƒë√¢y
            authDomain: "flutter-ai-playground-c65f3.firebaseapp.com",
            projectId: "flutter-ai-playground-c65f3",
            storageBucket: "flutter-ai-playground-c65f3.appspot.com",
            messagingSenderId: "932092331324",
            appId: "1:932092331324:web:dcbb33b44b5d55a43cca39"
        };
        // -------------------------------------------------------------

        // --- Bi·∫øn to√†n c·ª•c ---
        let app, db, auth;
        let userId;
        let categoriesCol, schedulesCol;
        let teachersCol, classesCol; // (S·ª¨A) Th√™m
        let unsubscribeCategories, unsubscribeSchedules;
        let unsubscribeTeachers, unsubscribeClasses; // (S·ª¨A) Th√™m
        let calendar; // (M·ªöI) ƒê∆∞a calendar ra to√†n c·ª•c
        let currentConfirmCallback;

        let categories = [];
        let schedules = [];
        let allTeachers = []; // (S·ª¨A) Th√™m
        let allClasses = []; // (S·ª¨A) Th√™m
        const DEFAULT_CATEGORY_ID_PERSONAL = 'canhan';
        const DEFAULT_CATEGORIES = [
            { id: 'giangday', name: 'Gi·∫£ng d·∫°y', color: '#2563eb' },
            { id: 'hop', name: 'H·ªçp', color: '#d97706' },
            { id: 'coithi', name: 'Coi thi', color: '#dc2626' },
            { id: DEFAULT_CATEGORY_ID_PERSONAL, name: 'Vi·ªác c√° nh√¢n', color: '#57534e', nodelete: true }
        ];

        // (M·ªöI) Icon cho Ch·∫ø ƒë·ªô S√°ng/T·ªëi
        const sunIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
        const moonIcon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>`;

        // (M·ªöI) Bi·∫øn cho Ng√¥n ng·ªØ
        let currentLang = 'vi';
        const translations = {
            'vi': {
                pageTitle: "Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu",
                mainTitle: "Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu",
                connecting: "ƒêang k·∫øt n·ªëi...",
                notLoggedIn: "Ch∆∞a ƒëƒÉng nh·∫≠p",
                loginWelcome: "Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi L·ªãch",
                loginPrompt: "Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô h√≥a th·ªùi kh√≥a bi·ªÉu c·ªßa b·∫°n.",
                loginButton: "ƒêƒÉng nh·∫≠p b·∫±ng Google",
                loginError: "L·ªói ƒëƒÉng nh·∫≠p: {message}. Vui l√≤ng th·ª≠ l·∫°i.",
                menuLabel: "Ch·ª©c nƒÉng",
                searchPlaceholder: "T√¨m ki·∫øm...",
                filterLabel: "L·ªçc theo:",
                allOption: "T·∫•t c·∫£",
                manageCategories: "Qu·∫£n l√Ω Ph√¢n lo·∫°i",
                exportExcel: "Xu·∫•t Excel",
                themeLight: "Ch·∫ø ƒë·ªô S√°ng",
                themeDark: "Ch·∫ø ƒë·ªô T·ªëi",
                language: "Ng√¥n ng·ªØ",
                logout: "ƒêƒÉng xu·∫•t",
                calendarButtonText: { today: 'H√¥m nay', month: 'Th√°ng', week: 'Tu·∫ßn', day: 'Ng√†y' },
                modalTitleAdd: "Th√™m S·ª± ki·ªán",
                modalTitleEdit: "S·ª≠a S·ª± ki·ªán",
                modalTitleLabel: "Ti√™u ƒë·ªÅ",
                modalDateLabel: "Ng√†y",
                modalTimeStartLabel: "Gi·ªù B·∫Øt ƒë·∫ßu",
                modalTimeEndLabel: "Gi·ªù K·∫øt th√∫c",
                modalAllDayLabel: "C·∫£ ng√†y",
                modalCompletedLabel: "ƒê√£ ho√†n th√†nh", // M·ªöI
                modalCategoryLabel: "Ph√¢n lo·∫°i",
                modalClassLabel: "L·ªõp (T√πy ch·ªçn)",
                modalTeacherLabel: "Gi√°o vi√™n (T√πy ch·ªçn)",
                modalLocationLabel: "ƒê·ªãa ƒëi·ªÉm (T√πy ch·ªçn)",
                modalDescriptionLabel: "M√¥ t·∫£ (T√πy ch·ªçn)",
                modalTimeError: "L·ªói: Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu.",
                modalDeleteButton: "X√≥a",
                modalCloseButton: "ƒê√≥ng",
                modalSaveButton: "S·ª≠a",
                confirmTitle: "X√°c nh·∫≠n",
                confirmMessage: "B·∫°n c√≥ ch·∫Øc ch·∫Øn?",
                confirmCancel: "H·ªßy",
                confirmOK: "OK",
                confirmDeleteTitle: "X√°c nh·∫≠n X√≥a",
                confirmDeleteEvent: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán n√†y?",
                confirmDeleteEventOK: "X√≥a",
                personalCategory: "Vi·ªác c√° nh√¢n", // (S·ª¨A) Th√™m key d·ªãch chu·∫©n
                confirmDeleteCategoryMsg: `X√≥a "{name}"? C√°c s·ª± ki·ªán d√πng ph√¢n lo·∫°i n√†y s·∫Ω ƒë∆∞·ª£c chuy·ªÉn th√†nh "Vi·ªác c√° nh√¢n".`,
                catModalTitle: "Qu·∫£n l√Ω Ph√¢n lo·∫°i",
                catModalAddFormLabel: "T√™n Ph√¢n lo·∫°i",
                catModalColorLabel: "M√†u",
                catModalAddButton: "Th√™m",
                catModalEditFormLabel: "S·ª≠a T√™n Ph√¢n lo·∫°i",
                catModalSaveButton: "S·ª≠a",
                catModalCancelButton: "H·ªßy",
                catModalExistingLabel: "C√°c Ph√¢n lo·∫°i Hi·ªán c√≥",
                catModalNameExists: "T√™n ph√¢n lo·∫°i n√†y ƒë√£ t·ªìn t·∫°i.",
                tooltipCategory: "Ph√¢n lo·∫°i",
                tooltipClass: "L·ªõp",
                tooltipTeacher: "Gi√°o vi√™n",
                tooltipLocation: "ƒê·ªãa ƒëi·ªÉm",
                tooltipDescription: "M√¥ t·∫£",
                tooltipStatus: "Tr·∫°ng th√°i", // M·ªöI
                excelNoData: "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.",
                excelError: "ƒê√£ x·∫£y ra l·ªói khi c·ªë g·∫Øng xu·∫•t t·ªáp Excel.",
                excelSheetName: "ThoiKhoaBieu",
                excelHeaders: ["Ti√™u ƒë·ªÅ", "Ng√†y", "Gi·ªù b·∫Øt ƒë·∫ßu", "Gi·ªù k·∫øt th√∫c", "Ph√¢n lo·∫°i", "L·ªõp", "Gi√°o vi√™n d·∫°y", "ƒê·ªãa ƒëi·ªÉm", "M√¥ t·∫£", "Tr·∫°ng th√°i"], // M·ªöI
                excelAllDay: "C·∫£ ng√†y",
                statusCompleted: "ƒê√£ ho√†n th√†nh", // M·ªöI
                statusInProgress: "Ch∆∞a xong", // M·ªöI
                notifyTomorrowTitle: "Th√¥ng b√°o L·ªãch tr√¨nh Ng√†y mai",
                notifyTomorrowMsg: `B·∫°n c√≥ {count} s·ª± ki·ªán v√†o ng√†y mai ({date}): {events}.`,
                notifyOK: "ƒê√£ hi·ªÉu"
            },
            'en': {
                pageTitle: "Schedule Management",
                mainTitle: "Schedule Management",
                connecting: "Connecting...",
                notLoggedIn: "Not logged in",
                loginWelcome: "Welcome to Calendar",
                loginPrompt: "Please log in to sync your schedule.",
                loginButton: "Sign in with Google",
                loginError: "Login error: {message}. Please try again.",
                menuLabel: "Functions",
                searchPlaceholder: "Search...",
                filterLabel: "Filter by:",
                allOption: "All",
                manageCategories: "Manage Categories",
                exportExcel: "Export Excel",
                themeLight: "Light Mode",
                themeDark: "Dark Mode",
                language: "Language",
                logout: "Logout",
                calendarButtonText: { today: 'Today', month: 'Month', week: 'Week', day: 'Day' },
                modalTitleAdd: "Add Event",
                modalTitleEdit: "Edit Event",
                modalTitleLabel: "Title",
                modalDateLabel: "Date",
                modalTimeStartLabel: "Start Time",
                modalTimeEndLabel: "End Time",
                modalAllDayLabel: "All day",
                modalCompletedLabel: "Completed", // M·ªöI
                modalCategoryLabel: "Category",
                modalClassLabel: "Class (Optional)",
                modalTeacherLabel: "Teacher (Optional)",
                modalLocationLabel: "Location (Optional)",
                modalDescriptionLabel: "Description (Optional)",
                modalTimeError: "Error: End time must be after start time.",
                modalDeleteButton: "Delete",
                modalCloseButton: "Close",
                modalSaveButton: "Save",
                confirmTitle: "Confirm",
                confirmMessage: "Are you sure?",
                confirmCancel: "Cancel",
                confirmOK: "OK",
                confirmDeleteTitle: "Confirm Deletion",
                confirmDeleteEvent: "Are you sure you want to delete this event?",
                confirmDeleteEventOK: "Delete",
                personalCategory: "Personal", // (S·ª¨A) Th√™m key d·ªãch chu·∫©n
                confirmDeleteCategoryMsg: `Delete "{name}"? Events using this category will be moved to "Personal".`,
                catModalTitle: "Manage Categories",
                catModalAddFormLabel: "Category Name",
                catModalColorLabel: "Color",
                catModalAddButton: "Add",
                catModalEditFormLabel: "Edit Category Name",
                catModalSaveButton: "Save",
                catModalCancelButton: "Cancel",
                catModalExistingLabel: "Existing Categories",
                catModalNameExists: "This category name already exists.",
                tooltipCategory: "Category",
                tooltipClass: "Class",
                tooltipTeacher: "Teacher",
                tooltipLocation: "Location",
                tooltipDescription: "Description",
                tooltipStatus: "Status", // M·ªöI
                excelNoData: "No data to export.",
                excelError: "An error occurred while trying to export the Excel file.",
                excelSheetName: "Schedule",
                excelHeaders: ["Title", "Date", "Start Time", "End Time", "Category", "Class", "Teacher", "Location", "Description", "Status"], // M·ªöI
                excelAllDay: "All day",
                statusCompleted: "Completed", // M·ªöI
                statusInProgress: "In Progress", // M·ªöI
                notifyTomorrowTitle: "Tomorrow's Schedule Notification",
                notifyTomorrowMsg: `You have {count} events tomorrow ({date}): {events}.`,
                notifyOK: "Got it"
            },
            'fr': {
                pageTitle: "Gestion d'horaire",
                mainTitle: "Gestion d'horaire",
                connecting: "Connexion...",
                notLoggedIn: "Non connect√©",
                loginWelcome: "Bienvenue au Calendrier",
                loginPrompt: "Veuillez vous connecter pour synchroniser votre horaire.",
                loginButton: "Se connecter avec Google",
                loginError: "Erreur de connexion : {message}. Veuillez r√©essayer.",
                menuLabel: "Fonctions",
                searchPlaceholder: "Rechercher...",
                filterLabel: "Filtrer par :",
                allOption: "Tous",
                manageCategories: "G√©rer les Cat√©gories",
                exportExcel: "Exporter Excel",
                themeLight: "Mode Clair",
                themeDark: "Mode Sombre",
                language: "Langue",
                logout: "D√©connexion",
                calendarButtonText: { today: "Aujourd'hui", month: 'Mois', week: 'Semaine', day: 'Jour' },
                modalTitleAdd: "Ajouter un √âv√©nement",
                modalTitleEdit: "Modifier l'√âv√©nement",
                modalTitleLabel: "Titre",
                modalDateLabel: "Date",
                modalTimeStartLabel: "Heure de d√©but",
                modalTimeEndLabel: "Heure de fin",
                modalAllDayLabel: "Toute la journ√©e",
                modalCompletedLabel: "Termin√©", // M·ªöI
                modalCategoryLabel: "Cat√©gorie",
                modalClassLabel: "Classe (Optionnel)",
                modalTeacherLabel: "Enseignant (Optionnel)",
                modalLocationLabel: "Lieu (Optionnel)",
                modalDescriptionLabel: "Description (Optionnel)",
                modalTimeError: "Erreur : L'heure de fin doit √™tre apr√®s l'heure de d√©but.",
                modalDeleteButton: "Supprimer",
                modalCloseButton: "Fermer",
                modalSaveButton: "Enregistrer",
                confirmTitle: "Confirmer",
                confirmMessage: "√ätes-vous s√ªr ?",
                confirmCancel: "Annuler",
                confirmOK: "OK",
                confirmDeleteTitle: "Confirmer la Suppression",
                confirmDeleteEvent: "√ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?",
                confirmDeleteEventOK: "Supprimer",
                personalCategory: "Personnel", // (S·ª¨A) Th√™m key d·ªãch chu·∫©n
                confirmDeleteCategoryMsg: `Supprimer "{name}" ? Les √©v√©nements utilisant cette cat√©gorie seront d√©plac√©s vers "Personnel".`,
                catModalTitle: "G√©rer les Cat√©gories",
                catModalAddFormLabel: "Nom de la Cat√©gorie",
                catModalColorLabel: "Couleur",
                catModalAddButton: "Ajouter",
                catModalEditFormLabel: "Modifier le Nom de la Cat√©gorie",
                catModalSaveButton: "Enregistrer",
                catModalCancelButton: "Annuler",
                catModalExistingLabel: "Cat√©gories Existantes",
                catModalNameExists: "Ce nom de cat√©gorie existe d√©j√†.",
                tooltipCategory: "Cat√©gorie",
                tooltipClass: "Classe",
                tooltipTeacher: "Enseignant",
                tooltipLocation: "Lieu",
                tooltipDescription: "Description",
                tooltipStatus: "Statut", // M·ªöI
                excelNoData: "Aucune donn√©e √† exporter.",
                excelError: "Une erreur est survenue lors de l'exportation du fichier Excel.",
                excelSheetName: "Horaire",
                excelHeaders: ["Titre", "Date", "Heure de d√©but", "Heure de fin", "Cat√©gorie", "Classe", "Enseignant", "Lieu", "Description", "Statut"], // M·ªöI
                excelAllDay: "Toute la journ√©e",
                statusCompleted: "Termin√©", // M·ªöI
                statusInProgress: "En cours", // M·ªöI
                notifyTomorrowTitle: "Notification d'horaire de demain",
                notifyTomorrowMsg: `Vous avez {count} √©v√©nements demain ({date}) : {events}.`,
                notifyOK: "Compris"
            }
        };


        document.addEventListener('DOMContentLoaded', async function () {
            // --- L·∫•y c√°c ph·∫ßn t·ª≠ DOM ---
            // (M·ªöI) DOM cho Ch·∫ø ƒë·ªô S√°ng/T·ªëi
            const themeToggle = document.getElementById('themeToggle');
            const themeToggleDesktop = document.getElementById('themeToggleDesktop');

            // (M·ªöI) DOM cho Ng√¥n ng·ªØ
            const langSwitch = document.getElementById('langSwitch');
            const langSwitchDesktop = document.getElementById('langSwitchDesktop');

            // (M·ªöI) DOM cho X√°c th·ª±c
            const authScreen = document.getElementById('authScreen');
            const loginButton = document.getElementById('loginButton');
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const logoutButton = document.getElementById('logoutButton');
            const logoutButtonDesktop = document.getElementById('logoutButtonDesktop');

            const appContent = document.getElementById('appContent');
            const calendarEl = document.getElementById('calendar');
            const modal = document.getElementById('eventModal');
            const modalTitle = document.getElementById('modalTitle');
            const eventForm = document.getElementById('eventForm');
            const eventIdInput = document.getElementById('eventIdInput');
            const eventTitleInput = document.getElementById('eventTitle');
            const eventDateInput = document.getElementById('eventDate');
            const eventTimeInput = document.getElementById('eventTime');
            const eventEndTimeInput = document.getElementById('eventEndTime');
            const timeInputGroup = document.getElementById('timeInputGroup');
            const eventAllDayInput = document.getElementById('eventAllDay');
            const eventCompletedInput = document.getElementById('eventCompleted'); // M·ªöI
            const eventCategoryInput = document.getElementById('eventCategory');
            // (M·ªöI) DOM cho tr∆∞·ªùng L·ªõp v√† Gi√°o vi√™n
            const eventClassInput = document.getElementById('eventClass');
            const eventTeacherInput = document.getElementById('eventTeacher');
            const eventLocationInput = document.getElementById('eventLocation');
            const eventDescriptionInput = document.getElementById('eventDescription');
            const classList = document.getElementById('classList'); // (S·ª¨A) Th√™m
            const teacherList = document.getElementById('teacherList'); // (S·ª¨A) Th√™m
            const saveButton = document.getElementById('saveButton');
            const deleteButton = document.getElementById('deleteButton');
            const closeModalButton = document.getElementById('closeModalButton');
            const timeError = document.getElementById('timeError');
            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmCancel = document.getElementById('confirmCancel');
            const confirmOK = document.getElementById('confirmOK');
            const categoryModal = document.getElementById('categoryModal');
            const closeCategoryModalButton = document.getElementById('closeCategoryModalButton');
            const addCategoryForm = document.getElementById('addCategoryForm');
            const newCategoryNameInput = document.getElementById('newCategoryName');
            const newCategoryColorInput = document.getElementById('newCategoryColor');
            const categoryList = document.getElementById('categoryList');
            const dynamicStyles = document.getElementById('dynamic-category-styles');
            const editCategoryForm = document.getElementById('editCategoryForm');
            const editCategoryIdInput = document.getElementById('editCategoryId');
            const editCategoryNameInput = document.getElementById('editCategoryName');
            const editCategoryColorInput = document.getElementById('editCategoryColor');
            const cancelEditButton = document.getElementById('cancelEditButton');
            const menuOpenButton = document.getElementById('menuOpenButton');
            const menuCloseButton = document.getElementById('menuCloseButton');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const searchInput = document.getElementById('searchInput');
            const searchInputDesktop = document.getElementById('searchInputDesktop');
            const categoryFilter = document.getElementById('categoryFilter');
            const manageCategoriesButton = document.getElementById('manageCategoriesButton');
            const categoryFilterDesktop = document.getElementById('categoryFilterDesktop');
            const manageCategoriesButtonDesktop = document.getElementById('manageCategoriesButtonDesktop');
            const exportExcelButton = document.getElementById('exportExcelButton');
            const exportExcelButtonDesktop = document.getElementById('exportExcelButtonDesktop');

            // --- (M·ªöI) 0. Kh·ªüi t·∫°o Ch·∫ø ƒë·ªô S√°ng/T·ªëi ---
            function updateThemeUI(isDarkMode) {
                const icon = isDarkMode ? sunIcon : moonIcon;
                const text = isDarkMode ? translations[currentLang].themeLight : translations[currentLang].themeDark;
                themeToggle.innerHTML = `${icon}<span>${text}</span>`;
                themeToggleDesktop.innerHTML = icon;
                themeToggleDesktop.setAttribute('aria-label', text);
            }

            function applyTheme() {
                const theme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (theme === 'dark' || (!theme && prefersDark)) {
                    document.documentElement.classList.add('dark');
                    updateThemeUI(true);
                } else {
                    document.documentElement.classList.remove('dark');
                    updateThemeUI(false);
                }
            }

            function toggleTheme() {
                const isDarkMode = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                updateThemeUI(isDarkMode);
            }

            themeToggle.addEventListener('click', toggleTheme);
            themeToggleDesktop.addEventListener('click', toggleTheme);
            // applyTheme() s·∫Ω ƒë∆∞·ª£c g·ªçi b√™n trong setLanguage()

            // --- (M·ªöI) 0. Kh·ªüi t·∫°o Ng√¥n ng·ªØ ---
            function setLanguage(lang) {
                if (!translations[lang]) lang = 'vi';
                currentLang = lang;
                localStorage.setItem('language', lang);
                document.documentElement.lang = lang;

                // C·∫≠p nh·∫≠t c√°c select
                langSwitch.value = lang;
                langSwitchDesktop.value = lang;

                // D·ªãch t·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ c√≥ data-lang-key
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    const translation = translations[lang][key];
                    if (translation) {
                        el.innerText = translation;
                    }
                });

                // D·ªãch c√°c placeholder
                document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-lang-key-placeholder');
                    const translation = translations[lang][key];
                    if (translation) {
                        el.placeholder = translation;
                    }
                });

                // C·∫≠p nh·∫≠t Locale cho Calendar (n·∫øu ƒë√£ kh·ªüi t·∫°o)
                if (calendar) {
                    calendar.setOption('locale', lang);
                    calendar.setOption('buttonText', translations[lang].calendarButtonText);
                }

                // C·∫≠p nh·∫≠t l·∫°i UI S√°ng/T·ªëi (v√¨ text ƒë√£ thay ƒë·ªïi)
                updateThemeUI(document.documentElement.classList.contains('dark'));

                // (M·ªöI) C·∫≠p nh·∫≠t c√°c option trong filter
                populateCategoryDropdowns();
            }

            langSwitch.addEventListener('change', (e) => setLanguage(e.target.value));
            langSwitchDesktop.addEventListener('change', (e) => setLanguage(e.target.value));

            // √Åp d·ª•ng ng√¥n ng·ªØ ƒë√£ l∆∞u ho·∫∑c m·∫∑c ƒë·ªãnh
            setLanguage(localStorage.getItem('language') || 'vi');
            applyTheme(); // √Åp d·ª•ng theme sau khi c√≥ ng√¥n ng·ªØ


            // --- (M·ªöI) 1. Kh·ªüi t·∫°o Firebase (ƒê∆°n gi·∫£n h√≥a) ---
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
            } catch (error) {
                console.error("L·ªói kh·ªüi t·∫°o Firebase:", error);
                authScreen.innerHTML = `<div class="text-center text-red-600">L·ªói nghi√™m tr·ªçng khi kh·ªüi t·∫°o Firebase: ${error.message}</div>`;
                return;
            }

            // --- (M·ªöI) 2. B·ªô n√£o X√°c th·ª±c: L·∫Øng nghe thay ƒë·ªïi ƒêƒÉng nh·∫≠p/ƒêƒÉng xu·∫•t ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // --- A. NG∆Ø·ªúI D√ôNG ƒê√É ƒêƒÇNG NH·∫¨P ---
                    userId = user.uid;

                    // C·∫≠p nh·∫≠t UI
                    userInfoDisplay.innerText = user.displayName || user.email || 'Ng∆∞·ªùi d√πng';
                    userInfoDisplay.title = `UserID: ${user.uid}`;
                    logoutButton.classList.remove('hidden');
                    logoutButtonDesktop.classList.remove('hidden');

                    // ƒê·ªãnh nghƒ©a ƒë∆∞·ªùng d·∫´n CSDL cho ng∆∞·ªùi d√πng n√†y
                    const userPath = `users/${userId}`;
                    categoriesCol = collection(db, `${userPath}/schedule_categories`);
                    schedulesCol = collection(db, `${userPath}/schedule_events`);
                    teachersCol = collection(db, `${userPath}/schedule_teachers`); // (S·ª¨A) Th√™m
                    classesCol = collection(db, `${userPath}/schedule_classes`); // (S·ª¨A) Th√™m

                    // Hi·ªÉn th·ªã ·ª©ng d·ª•ng
                    authScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');

                    // Kh·ªüi ƒë·ªông listener v√† v·∫Ω l·ªãch
                    await startAppListenersAndCalendar();

                } else {
                    // --- B. NG∆Ø·ªúI D√ôNG ƒê√É ƒêƒÇNG XU·∫§T ---
                    userId = null;

                    // D·ªçn d·∫πp listener c≈©
                    if (unsubscribeCategories) unsubscribeCategories();
                    if (unsubscribeSchedules) unsubscribeSchedules();
                    if (unsubscribeTeachers) unsubscribeTeachers(); // (S·ª¨A) Th√™m
                    if (unsubscribeClasses) unsubscribeClasses(); // (S·ª¨A) Th√™m
                    categories = [];
                    schedules = [];
                    allTeachers = []; // (S·ª¨A) Th√™m
                    allClasses = []; // (S·ª¨A) Th√™m

                    // H·ªßy l·ªãch c≈© (n·∫øu c√≥)
                    if (calendar) {
                        calendar.destroy();
                        calendar = null;
                    }

                    // C·∫≠p nh·∫≠t UI
                    userInfoDisplay.innerText = translations[currentLang].notLoggedIn;
                    userInfoDisplay.title = '';
                    logoutButton.classList.add('hidden');
                    logoutButtonDesktop.classList.add('hidden');

                    // Hi·ªÉn th·ªã m√†n h√¨nh ƒëƒÉng nh·∫≠p
                    authScreen.classList.remove('hidden');
                    appContent.classList.add('hidden');
                }
            });

            // --- (M·ªöI) 3. X·ª≠ l√Ω c√°c n√∫t ƒêƒÉng nh·∫≠p / ƒêƒÉng xu·∫•t ---
            async function handleLogin() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω ph·∫ßn c√≤n l·∫°i
                } catch (error) {
                    console.error("L·ªói khi ƒëƒÉng nh·∫≠p Google:", error);
                    authScreen.querySelector('#loginError').innerText = translations[currentLang].loginError.replace('{message}', error.message);
                }
            }

            async function handleLogout() {
                try {
                    await signOut(auth);
                    // onAuthStateChanged s·∫Ω t·ª± ƒë·ªông x·ª≠ l√Ω ph·∫ßn c√≤n l·∫°i
                } catch (error) {
                    console.error("L·ªói khi ƒëƒÉng xu·∫•t:", error);
                }
            }

            loginButton.addEventListener('click', handleLogin);
            logoutButton.addEventListener('click', handleLogout);
            logoutButtonDesktop.addEventListener('click', handleLogout);

            // --- (M·ªöI) 4. H√†m kh·ªüi ƒë·ªông ·ª©ng d·ª•ng (SAU KHI ƒêƒÇNG NH·∫¨P) ---
            async function startAppListenersAndCalendar() {
                if (!userId) return; // B·∫£o v·ªá

                await checkAndSeedCategories();

                loadCategories(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe
                loadSchedules(); // B·∫Øt ƒë·∫ßu l·∫Øng nghe
                loadTeachers(); // (S·ª¨A) Th√™m
                loadClasses(); // (S·ª¨A) Th√™m

                // N·∫øu l·ªãch ƒë√£ t·ªìn t·∫°i, h·ªßy n√≥ tr∆∞·ªõc khi t·∫°o m·ªõi
                if (calendar) {
                    calendar.destroy();
                    calendar = null;
                }

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: currentLang, // (M·ªöI) S·ª≠ d·ª•ng ng√¥n ng·ªØ hi·ªán t·∫°i
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    buttonText: translations[currentLang].calendarButtonText, // (M·ªöI) S·ª≠ d·ª•ng text t·ª´ b·∫£n d·ªãch
                    editable: true,
                    selectable: true,
                    eventResizableFromStart: true,
                    events: function (fetchInfo, successCallback, failureCallback) {
                        try {
                            const selectedCategory = categoryFilterDesktop.value;
                            const searchTerm = searchInputDesktop.value.toLowerCase().trim();
                            const canhanCatId = DEFAULT_CATEGORY_ID_PERSONAL;
                            let filteredSchedules = [...schedules];
                            if (selectedCategory !== 'all') {
                                filteredSchedules = filteredSchedules.filter(item => {
                                    const itemCatId = item.category || canhanCatId;
                                    return itemCatId === selectedCategory;
                                });
                            }
                            if (searchTerm) {
                                filteredSchedules = filteredSchedules.filter(item =>
                                    item.title.toLowerCase().includes(searchTerm) ||
                                    (item.location || '').toLowerCase().includes(searchTerm) ||
                                    (item.description || '').toLowerCase().includes(searchTerm) ||
                                    (item.class || '').toLowerCase().includes(searchTerm) ||
                                    (item.teacher || '').toLowerCase().includes(searchTerm)
                                );
                            }
                            const events = mapSchedulesToCalendarEvents(filteredSchedules);
                            successCallback(events);
                        } catch (e) {
                            failureCallback(e);
                        }
                    },
                    dateClick: function (info) {
                        openModal({ date: info.dateStr });
                    },
                    eventClick: function (info) {
                        if (!info.event.id) return;
                        openModal({ eventId: info.event.id });
                    },
                    eventDrop: async function (info) {
                        const eventId = info.event.id;
                        if (!eventId) return;
                        const item = schedules.find(s => s.id === eventId);
                        if (!item) return;
                        const newStartDate = info.event.start;
                        if (!newStartDate) return;
                        const newDate = formatDate(newStartDate);
                        const isAllDay = info.event.allDay;
                        let newTime = null;
                        let newEndTime = null;
                        if (!isAllDay) {
                            newTime = formatTime(newStartDate);
                            if (item.time && item.endTime) {
                                const oldStartMS = (parseInt(item.time.split(':')[0]) * 60 + parseInt(item.time.split(':')[1])) * 60000;
                                const oldEndMS = (parseInt(item.endTime.split(':')[0]) * 60 + parseInt(item.endTime.split(':')[1])) * 60000;
                                const duration = oldEndMS - oldStartMS;
                                if (duration > 0) {
                                    const newEndTimeObj = new Date(newStartDate.getTime() + duration);
                                    newEndTime = formatTime(newEndTimeObj);
                                }
                            }
                        }
                        try {
                            const eventRef = doc(schedulesCol, eventId);
                            await updateDoc(eventRef, {
                                date: newDate,
                                allDay: isAllDay,
                                time: newTime,
                                endTime: newEndTime
                            });
                        } catch (error) {
                            console.error("L·ªói khi k√©o th·∫£ s·ª± ki·ªán:", error);
                            info.revert();
                        }
                    },
                    eventResize: async function (info) {
                        const eventId = info.event.id;
                        if (!eventId) return;
                        const item = schedules.find(s => s.id === eventId);
                        if (!item || item.allDay) return;
                        try {
                            const eventRef = doc(schedulesCol, eventId);
                            await updateDoc(eventRef, {
                                time: formatTime(info.event.start),
                                endTime: formatTime(info.event.end)
                            });
                        } catch (error) {
                            console.error("L·ªói khi thay ƒë·ªïi k√≠ch th∆∞·ªõc s·ª± ki·ªán:", error);
                            info.revert();
                        }
                    },
                    eventMouseEnter: function (info) {
                        const props = info.event.extendedProps;
                        const categoryName = categories.find(c => c.id === props.category)?.name || '...';
                        const trans = translations[currentLang];
                        let title = `${trans.tooltipCategory}: ${categoryName}\n`;
                        // (M·ªöI) Th√™m L·ªõp, Gi√°o vi√™n, Tr·∫°ng th√°i v√†o tooltip
                        if (props.class) title += `${trans.tooltipClass}: ${props.class}\n`;
                        if (props.teacher) title += `${trans.tooltipTeacher}: ${props.teacher}\n`;
                        if (props.location) title += `${trans.tooltipLocation}: ${props.location}\n`;
                        if (props.description) title += `${trans.tooltipDescription}: ${props.description}\n`;
                        if (props.completed) title += `${trans.tooltipStatus}: ${trans.statusCompleted}\n`; // M·ªöI
                        info.el.title = title.trim();
                    }
                });

                calendar.render();
                calendar.updateSize(); // S·ª≠a l·ªói UI
            }

            // --- (M·ªöI) H√†m ki·ªÉm tra v√† th√™m Ph√¢n lo·∫°i m·∫∑c ƒë·ªãnh ---
            async function checkAndSeedCategories() {
                const snapshot = await getDocs(categoriesCol);
                if (snapshot.empty) {
                    console.log("Kh√¥ng t√¨m th·∫•y ph√¢n lo·∫°i, ƒëang th√™m m·∫∑c ƒë·ªãnh...");
                    const batch = writeBatch(db);
                    // (M·ªöI) D√πng ID l√†m key thay v√¨ name, ƒë·ªÉ h·ªó tr·ª£ ƒëa ng√¥n ng·ªØ
                    // T√™n s·∫Ω ƒë∆∞·ª£c d·ªãch, nh∆∞ng ID l√† c·ªë ƒë·ªãnh
                    // T√™n m·∫∑c ƒë·ªãnh ·ªü ƒë√¢y l√† Ti·∫øng Vi·ªát, v√¨ logic c≈© l√† v·∫≠y
                    DEFAULT_CATEGORIES.forEach(cat => {
                        const docRef = doc(categoriesCol, cat.id);
                        batch.set(docRef, {
                            name: cat.name, // T√™n 'g·ªëc' (ti·∫øng Vi·ªát)
                            color: cat.color,
                            nodelete: cat.nodelete || false
                        });
                    });
                    await batch.commit();
                }
            }

            // --- (M·ªöI) H√†m l·∫Øng nghe thay ƒë·ªïi Ph√¢n lo·∫°i ---
            function loadCategories() {
                if (unsubscribeCategories) unsubscribeCategories();
                unsubscribeCategories = onSnapshot(categoriesCol, (snapshot) => {
                    categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    injectDynamicCategoryStyles();
                    populateCategoryDropdowns();
                    if (!categoryModal.classList.contains('hidden')) {
                        renderCategoryList();
                    }
                    if (calendar) {
                        calendar.refetchEvents();
                    }
                }, (error) => {
                    console.error("L·ªói khi t·∫£i Ph√¢n lo·∫°i:", error);
                });
            }

            // --- (M·ªöI) H√†m l·∫Øng nghe thay ƒë·ªïi S·ª± ki·ªán ---
            function loadSchedules() {
                if (unsubscribeSchedules) unsubscribeSchedules();
                unsubscribeSchedules = onSnapshot(schedulesCol, (snapshot) => {
                    schedules = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (calendar) {
                        calendar.refetchEvents();
                    }
                    // (M·ªöI) Ki·ªÉm tra l·ªãch ng√†y mai sau khi t·∫£i
                    checkTomorrowSchedule(schedules);
                }, (error) => {
                    console.error("L·ªói khi t·∫£i S·ª± ki·ªán:", error);
                });
            }

            // (S·ª¨A) Th√™m h√†m l·∫Øng nghe Teachers, Classes v√† populate Datalists
            function loadTeachers() {
                if (unsubscribeTeachers) unsubscribeTeachers();
                unsubscribeTeachers = onSnapshot(teachersCol, (snapshot) => {
                    allTeachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateDatalists();
                }, (error) => {
                    console.error("L·ªói khi t·∫£i Gi√°o vi√™n:", error);
                });
            }

            function loadClasses() {
                if (unsubscribeClasses) unsubscribeClasses();
                unsubscribeClasses = onSnapshot(classesCol, (snapshot) => {
                    allClasses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    populateDatalists();
                }, (error) => {
                    console.error("L·ªói khi t·∫£i L·ªõp:", error);
                });
            }

            function populateDatalists() {
                if (!teacherList || !classList) return;

                teacherList.innerHTML = '';
                allTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    teacherList.appendChild(option);
                });

                classList.innerHTML = '';
                allClasses.sort((a, b) => a.name.localeCompare(b.name)).forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.name;
                    classList.appendChild(option);
                });
            }
            // K·∫øt th√∫c th√™m

            // --- H√†m Qu·∫£n l√Ω Ph√¢n lo·∫°i (d√πng Firestore) ---
            function injectDynamicCategoryStyles() {
                let css = "";
                categories.forEach(cat => {
                    css += `.fc-event.event-${cat.id} { background-color: ${cat.color}; border-color: ${cat.color}; color: #ffffff; }`;
                });
                // (M·ªöI) Th√™m style cho s·ª± ki·ªán ƒë√£ ho√†n th√†nh
                css += `.fc-event.event-completed { opacity: 0.8; /* Ch·ªâ l√†m m·ªù, kh√¥ng g·∫°ch ngang */ }`;
                dynamicStyles.innerHTML = css;
            }

            function populateCategoryDropdowns() {
                const currentFilterValue = categoryFilter.value || categoryFilterDesktop.value || 'all';
                const allOptionText = translations[currentLang].allOption;

                categoryFilter.innerHTML = `<option value="all">${allOptionText}</option>`;
                categoryFilterDesktop.innerHTML = `<option value="all">${allOptionText}</option>`;
                eventCategoryInput.innerHTML = '';

                categories.forEach(cat => {
                    // (M·ªöI) T·∫°m th·ªùi ch·ªâ hi·ªÉn th·ªã t√™n g·ªëc, v√¨ vi·ªác d·ªãch t√™n ph√¢n lo·∫°i do ng∆∞·ªùi d√πng t·∫°o ra r·∫•t ph·ª©c t·∫°p
                    // N·∫øu "Vi·ªác c√° nh√¢n" th√¨ d·ªãch
                    // (S·ª¨A) D√πng key 'personalCategory' thay v√¨ logic split() b·ªã l·ªói
                    const catName = (cat.id === DEFAULT_CATEGORY_ID_PERSONAL) ? translations[currentLang].personalCategory : cat.name;

                    const filterOption = document.createElement('option');
                    filterOption.value = cat.id;
                    filterOption.textContent = catName;
                    const filterOptionDesktop = filterOption.cloneNode(true);
                    categoryFilter.appendChild(filterOption);
                    categoryFilterDesktop.appendChild(filterOptionDesktop);

                    const formOption = document.createElement('option');
                    formOption.value = cat.id;
                    formOption.textContent = catName;
                    eventCategoryInput.appendChild(formOption);
                });

                categoryFilter.value = currentFilterValue;
                categoryFilterDesktop.value = currentFilterValue;
            }

            function renderCategoryList() {
                categoryList.innerHTML = '';
                categories.forEach(cat => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between p-2 border rounded-md dark:border-gray-600';
                    const left = document.createElement('div');
                    left.className = 'flex items-center gap-2';
                    const colorSwatch = document.createElement('span');
                    colorSwatch.className = 'w-5 h-5 rounded-full inline-block border';
                    colorSwatch.style.backgroundColor = cat.color;
                    const name = document.createElement('span');
                    // (M·ªöI) D·ªãch t√™n "Vi·ªác c√° nh√¢n"
                    // (S·ª¨A) D√πng key 'personalCategory' thay v√¨ logic split() b·ªã l·ªói
                    name.textContent = (cat.id === DEFAULT_CATEGORY_ID_PERSONAL) ? translations[currentLang].personalCategory : cat.name;
                    left.appendChild(colorSwatch);
                    left.appendChild(name);
                    div.appendChild(left);
                    const buttonsWrapper = document.createElement('div');
                    buttonsWrapper.className = 'flex items-center gap-3';
                    const editBtn = document.createElement('button');
                    editBtn.type = 'button';
                    editBtn.textContent = translations[currentLang].catModalSaveButton; // "S·ª≠a" -> "S·ª≠a"
                    editBtn.className = 'text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium';
                    editBtn.onclick = () => showEditCategoryForm(cat);
                    buttonsWrapper.appendChild(editBtn);
                    if (!cat.nodelete) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.type = 'button';
                        deleteBtn.textContent = translations[currentLang].modalDeleteButton;
                        deleteBtn.className = 'text-xs text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium';
                        deleteBtn.onclick = () => deleteCategory(cat.id);
                        buttonsWrapper.appendChild(deleteBtn);
                    }
                    div.appendChild(buttonsWrapper);
                    categoryList.appendChild(div);
                });
            }

            async function addCategory(e) {
                e.preventDefault();
                const name = newCategoryNameInput.value.trim();
                const color = newCategoryColorInput.value;
                if (!name) return;
                if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
                    newCategoryNameInput.setCustomValidity(translations[currentLang].catModalNameExists);
                    newCategoryNameInput.reportValidity();
                    setTimeout(() => newCategoryNameInput.setCustomValidity(""), 2000);
                    return;
                }
                newCategoryNameInput.setCustomValidity("");
                try {
                    await addDoc(categoriesCol, { name, color, nodelete: false });
                    newCategoryNameInput.value = '';
                } catch (error) {
                    console.error("L·ªói khi th√™m ph√¢n lo·∫°i:", error);
                }
            }

            async function deleteCategory(idToDelete) {
                if (categories.length <= 1) return;
                const category = categories.find(c => c.id === idToDelete);
                if (!category || category.nodelete) return;

                // (S·ª¨A) D√πng key 'personalCategory' thay v√¨ logic split() b·ªã l·ªói
                const catName = (category.id === DEFAULT_CATEGORY_ID_PERSONAL) ? translations[currentLang].personalCategory : category.name;
                const message = translations[currentLang].confirmDeleteCategoryMsg.replace('"{name}"', `"${catName}"`);

                openConfirmModal(message, translations[currentLang].confirmDeleteTitle, translations[currentLang].confirmDeleteEventOK, async () => {
                    try {
                        const q = query(schedulesCol, where("category", "==", idToDelete));
                        const snapshot = await getDocs(q);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => {
                            batch.update(doc.ref, { category: DEFAULT_CATEGORY_ID_PERSONAL });
                        });
                        await batch.commit();
                        await deleteDoc(doc(categoriesCol, idToDelete));
                    } catch (error) {
                        console.error("L·ªói khi x√≥a ph√¢n lo·∫°i:", error);
                    }
                });
            }

            function showEditCategoryForm(category) {
                addCategoryForm.classList.add('hidden');
                editCategoryForm.classList.remove('hidden');
                editCategoryIdInput.value = category.id;
                // (M·ªöI) D·ªãch t√™n "Vi·ªác c√° nh√¢n"
                // (S·ª¨A) D√πng key 'personalCategory' thay v√¨ logic split() b·ªã l·ªói
                editCategoryNameInput.value = (category.id === DEFAULT_CATEGORY_ID_PERSONAL) ? translations[currentLang].personalCategory : category.name;
                editCategoryColorInput.value = category.color;
                editCategoryNameInput.disabled = !!category.nodelete;
            }

            function hideEditCategoryForm() {
                editCategoryForm.classList.add('hidden');
                addCategoryForm.classList.remove('hidden');
                editCategoryIdInput.value = '';
                editCategoryNameInput.value = '';
                editCategoryNameInput.disabled = false;
                editCategoryNameInput.setCustomValidity("");
            }

            async function handleUpdateCategory(e) {
                e.preventDefault();
                const id = editCategoryIdInput.value;
                const name = editCategoryNameInput.value.trim();
                const color = editCategoryColorInput.value;
                if (!name) return;
                const categoryToUpdate = categories.find(c => c.id === id);
                if (!categoryToUpdate) return;
                // (M·ªöI) Khi ki·ªÉm tra tr√πng l·∫∑p, ph·∫£i so s√°nh v·ªõi t√™n g·ªëc, kh√¥ng ph·∫£i t√™n ƒë√£ d·ªãch
                // (S·ª¨A) S·ª≠a l·∫°i logic ki·ªÉm tra tr√πng l·∫∑p
                // Ch·ªâ ki·ªÉm tra n·∫øu KH√îNG ph·∫£i l√† ph√¢n lo·∫°i m·∫∑c ƒë·ªãnh (v√¨ n√≥ b·ªã v√¥ hi·ªáu h√≥a)
                if (!categoryToUpdate.nodelete && categories.some(cat => cat.id !== id && cat.name.toLowerCase() === name.toLowerCase())) {
                    editCategoryNameInput.setCustomValidity(translations[currentLang].catModalNameExists);
                    editCategoryNameInput.reportValidity();
                    setTimeout(() => editCategoryNameInput.setCustomValidity(""), 2000);
                    return;
                }
                editCategoryNameInput.setCustomValidity("");
                try {
                    const docRef = doc(categoriesCol, id);
                    const dataToUpdate = { color };
                    if (!categoryToUpdate.nodelete) {
                        dataToUpdate.name = name; // (S·ª¨A) D√πng t√™n t·ª´ form
                    }
                    await updateDoc(docRef, dataToUpdate);
                    hideEditCategoryForm();
                } catch (error) {
                    console.error("L·ªói khi c·∫≠p nh·∫≠t ph√¢n lo·∫°i:", error);
                }
            }

            // --- H√†m chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ---
            function mapSchedulesToCalendarEvents(scheduleData) {
                const canhanCatId = DEFAULT_CATEGORY_ID_PERSONAL;
                return scheduleData.map((item) => {
                    const categoryId = item.category && categories.find(c => c.id === item.category) ? item.category : canhanCatId;
                    const event = {
                        id: item.id,
                        title: (item.completed ? '‚úÖ ' : '') + item.title,
                        allDay: item.allDay || false,
                        // (M·ªöI) Th√™m class 'event-completed'
                        className: `event-${categoryId} ${item.allDay ? 'event-all-day' : ''} ${item.completed ? 'event-completed' : ''}`,
                        extendedProps: {
                            category: categoryId,
                            location: item.location || '',
                            description: item.description || '',
                            class: item.class || '',
                            teacher: item.teacher || '',
                            completed: item.completed || false // M·ªöI
                        }
                    };
                    if (item.allDay) {
                        event.start = item.date;
                    } else {
                        event.start = `${item.date}T${item.time || '00:00'}`;
                        if (item.endTime && item.time && item.endTime > item.time) {
                            event.end = `${item.date}T${item.endTime}`;
                        }
                    }
                    return event;
                });
            }

            // --- H√†m ƒë·ªãnh d·∫°ng th·ªùi gian ---
            function formatTime(date) {
                if (!date) return null;
                return date.toTimeString().slice(0, 5); // "HH:MM"
            }
            function formatDate(date) {
                if (!date) return null;
                return date.toISOString().slice(0, 10);
            }

            // --- (M·ªöI) H√†m ki·ªÉm tra l·ªãch ng√†y mai ---
            function checkTomorrowSchedule(scheduleData) {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowString = formatDate(tomorrow);

                // (S·ª¨A) X√≥a_b·ªè_sessionStorage_ƒë·ªÉ_th√¥ng_b√°o_lu√¥n_xu·∫•t_hi·ªán_khi_t·∫£i_trang
                // const notificationKey = `notified_tomorrow_${tomorrowString}`;

                // Ch·ªâ ki·ªÉm tra n·∫øu ch∆∞a th√¥ng b√°o trong session n√†y
                // if (sessionStorage.getItem(notificationKey)) {
                //     return;
                // }

                const tomorrowEvents = scheduleData.filter(item => item.date === tomorrowString);

                if (tomorrowEvents.length > 0) {
                    let eventTitles = tomorrowEvents.map(e => e.title).join(', ');
                    if (eventTitles.length > 100) { // C·∫Øt ng·∫Øn n·∫øu qu√° d√†i
                        eventTitles = eventTitles.substring(0, 100) + '...';
                    }
                    // (M·ªöI) D√πng b·∫£n d·ªãch
                    let message = translations[currentLang].notifyTomorrowMsg
                        .replace('{count}', tomorrowEvents.length)
                        .replace('{date}', tomorrowString)
                        .replace('{events}', eventTitles);

                    // S·ª≠ d·ª•ng modal x√°c nh·∫≠n l√†m th√¥ng b√°o
                    openConfirmModal(message, translations[currentLang].notifyTomorrowTitle, translations[currentLang].notifyOK, () => { });

                    // (S·ª¨A) X√≥a_b·ªè_sessionStorage_ƒë·ªÉ_th√¥ng_b√°o_lu√¥n_xu·∫•t_hi·ªán_khi_t·∫£i_trang
                    // sessionStorage.setItem(notificationKey, 'true');
                }
            }


            // --- H√†m b·∫≠t/t·∫Øt √¥ th·ªùi gian ---
            function toggleTimeInput() {
                if (eventAllDayInput.checked) {
                    timeInputGroup.classList.add('hidden');
                    eventTimeInput.required = false;
                    eventEndTimeInput.required = false;
                } else {
                    timeInputGroup.classList.remove('hidden');
                    eventTimeInput.required = true;
                    eventEndTimeInput.required = false;
                }
            }
            eventAllDayInput.addEventListener('change', toggleTimeInput);

            // --- H√†m M·ªü Modal S·ª± ki·ªán ---
            function openModal({ date, eventId }) {
                eventForm.reset();
                timeError.classList.add('hidden');
                const canhanCatId = DEFAULT_CATEGORY_ID_PERSONAL;
                if (eventId) {
                    const item = schedules.find(s => s.id === eventId);
                    if (!item) {
                        console.error("Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán v·ªõi ID:", eventId);
                        return;
                    }
                    modalTitle.innerText = translations[currentLang].modalTitleEdit;
                    eventIdInput.value = item.id;
                    eventTitleInput.value = item.title;
                    eventDateInput.value = item.date;
                    eventTimeInput.value = item.time || "08:00";
                    eventEndTimeInput.value = item.endTime || "";
                    eventCategoryInput.value = categories.find(c => c.id === item.category) ? item.category : canhanCatId;
                    eventAllDayInput.checked = item.allDay || false;
                    eventCompletedInput.checked = item.completed || false; // M·ªöI
                    eventClassInput.value = item.class || '';
                    eventTeacherInput.value = item.teacher || '';
                    eventLocationInput.value = item.location || '';
                    eventDescriptionInput.value = item.description || '';
                    deleteButton.classList.remove('hidden');
                } else {
                    modalTitle.innerText = translations[currentLang].modalTitleAdd;
                    eventIdInput.value = "";
                    eventDateInput.value = date;
                    eventTimeInput.value = "08:00";
                    eventEndTimeInput.value = "";
                    eventCategoryInput.value = categories[0]?.id || canhanCatId;
                    eventAllDayInput.checked = false;
                    eventCompletedInput.checked = false; // M·ªöI
                    eventClassInput.value = '';
                    eventTeacherInput.value = '';
                    eventLocationInput.value = '';
                    eventDescriptionInput.value = '';
                    deleteButton.classList.add('hidden');
                }
                toggleTimeInput();
                modal.classList.remove('hidden');
            }

            // --- H√†m ƒê√≥ng Modal S·ª± ki·ªán ---
            function closeModal() {
                modal.classList.add('hidden');
            }

            // --- H√†m cho Modal X√°c nh·∫≠n ---
            function openConfirmModal(message, title = translations[currentLang].confirmTitle, okText = translations[currentLang].confirmOK, onConfirm) {
                confirmTitle.innerText = title;
                confirmMessage.innerText = message || translations[currentLang].confirmMessage;
                confirmOK.innerText = okText;
                // (M·ªöI) So s√°nh v·ªõi text ƒë√£ d·ªãch
                if (okText === translations[currentLang].confirmDeleteEventOK || okText === 'Ghi ƒë√®') {
                    confirmOK.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'dark:bg-blue-500', 'dark:hover:bg-blue-600');
                    confirmOK.classList.add('bg-red-600', 'hover:bg-red-700', 'dark:bg-red-500', 'dark:hover:bg-red-600');
                } else {
                    confirmOK.classList.remove('bg-red-600', 'hover:bg-red-700', 'dark:bg-red-500', 'dark:hover:bg-red-600');
                    confirmOK.classList.add('bg-blue-600', 'hover:bg-blue-700', 'dark:bg-blue-500', 'dark:hover:bg-blue-600');
                }
                currentConfirmCallback = onConfirm;
                confirmModal.classList.remove('hidden');
            }
            function closeConfirmModal() {
                confirmModal.classList.add('hidden');
                currentConfirmCallback = null;
            }
            confirmCancel.addEventListener('click', closeConfirmModal);
            confirmOK.addEventListener('click', () => {
                if (currentConfirmCallback) {
                    currentConfirmCallback();
                }
                closeConfirmModal();
            });

            // --- X·ª≠ l√Ω s·ª± ki·ªán L∆∞u (Th√™m/C·∫≠p nh·∫≠t) v√†o Firestore ---
            eventForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                timeError.classList.add('hidden');
                const title = eventTitleInput.value.trim();
                const date = eventDateInput.value;
                const time = eventTimeInput.value;
                const endTime = eventEndTimeInput.value;
                const category = eventCategoryInput.value;
                const eventId = eventIdInput.value;
                const allDay = eventAllDayInput.checked;
                const completed = eventCompletedInput.checked; // M·ªöI
                const eventClass = eventClassInput.value.trim();
                const eventTeacher = eventTeacherInput.value.trim();
                const location = eventLocationInput.value.trim();
                const description = eventDescriptionInput.value.trim();
                if (!title || !date) {
                    console.error("Thi·∫øu Ti√™u ƒë·ªÅ ho·∫∑c Ng√†y");
                    return;
                }
                if (!allDay && time && endTime && endTime <= time) {
                    timeError.innerText = translations[currentLang].modalTimeError;
                    timeError.classList.remove('hidden');
                    return;
                }

                // (S·ª¨A) Th√™m logic ki·ªÉm tra v√† l∆∞u L·ªõp/Gi√°o vi√™n m·ªõi
                try {
                    if (eventClass && !allClasses.some(c => c.name.toLowerCase() === eventClass.toLowerCase())) {
                        await addDoc(classesCol, { name: eventClass });
                    }
                    if (eventTeacher && !allTeachers.some(t => t.name.toLowerCase() === eventTeacher.toLowerCase())) {
                        await addDoc(teachersCol, { name: eventTeacher });
                    }
                } catch (err) {
                    console.error("L·ªói khi l∆∞u L·ªõp/Gi√°o vi√™n m·ªõi:", err);
                    // Kh√¥ng ch·∫∑n vi·ªác l∆∞u s·ª± ki·ªán
                }

                const eventData = {
                    title, date,
                    time: allDay ? null : time,
                    endTime: (allDay || !endTime) ? null : endTime,
                    category, allDay, completed, // M·ªöI
                    class: eventClass,
                    teacher: eventTeacher,
                    location, description
                };
                try {
                    if (eventId) {
                        const eventRef = doc(schedulesCol, eventId);
                        await updateDoc(eventRef, eventData);
                    } else {
                        await addDoc(schedulesCol, eventData);
                    }
                    closeModal();
                } catch (error) {
                    console.error("L·ªói khi l∆∞u s·ª± ki·ªán:", error);
                }
            });

            // --- X·ª≠ l√Ω s·ª± ki·ªán X√≥a kh·ªèi Firestore ---
            deleteButton.addEventListener('click', function () {
                const eventId = eventIdInput.value;
                if (!eventId) return;
                openConfirmModal(
                    translations[currentLang].confirmDeleteEvent,
                    translations[currentLang].confirmDeleteTitle,
                    translations[currentLang].confirmDeleteEventOK,
                    async () => {
                        try {
                            await deleteDoc(doc(schedulesCol, eventId));
                            closeModal();
                        } catch (error) {
                            console.error("L·ªói khi x√≥a s·ª± ki·ªán:", error);
                        }
                    }
                );
            });

            // --- X·ª≠ l√Ω n√∫t ƒê√≥ng Modal S·ª± ki·ªán ---
            closeModalButton.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => (e.target === modal) && closeModal());

            // --- X·ª≠ l√Ω s·ª± ki·ªán cho Modal Ph√¢n lo·∫°i ---
            function openCategoryModal() {
                renderCategoryList();
                categoryModal.classList.remove('hidden');
            }
            manageCategoriesButton.addEventListener('click', () => {
                openCategoryModal();
                closeSidebar();
            });
            manageCategoriesButtonDesktop.addEventListener('click', openCategoryModal);
            closeCategoryModalButton.addEventListener('click', () => {
                categoryModal.classList.add('hidden');
                hideEditCategoryForm();
            });
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                    categoryModal.classList.add('hidden');
                    hideEditCategoryForm();
                }
            });
            addCategoryForm.addEventListener('submit', addCategory);
            editCategoryForm.addEventListener('submit', handleUpdateCategory);
            cancelEditButton.addEventListener('click', hideEditCategoryForm);

            // --- X·ª≠ l√Ω ƒë·ªìng b·ªô h√≥a B·ªô l·ªçc & T√¨m ki·∫øm ---
            categoryFilter.addEventListener('change', () => {
                categoryFilterDesktop.value = categoryFilter.value;
                calendar.refetchEvents();
                closeSidebar();
            });
            categoryFilterDesktop.addEventListener('change', () => {
                categoryFilter.value = categoryFilterDesktop.value;
                calendar.refetchEvents();
            });
            function handleSearch() {
                calendar.refetchEvents();
            }
            searchInput.addEventListener('input', () => {
                searchInputDesktop.value = searchInput.value;
                handleSearch();
            });
            searchInputDesktop.addEventListener('input', () => {
                searchInput.value = searchInputDesktop.value;
                handleSearch();
            });

            // --- X·ª≠ l√Ω Xu·∫•t Excel (C·∫≠p nh·∫≠t) ---
            function exportToExcel() {
                if (!schedules || schedules.length === 0) {
                    openConfirmModal(translations[currentLang].excelNoData, translations[currentLang].notifyTomorrowTitle, translations[currentLang].notifyOK, () => { });
                    return;
                }
                const categoriesMap = new Map(categories.map(cat => {
                    // (S·ª¨A) D√πng key 'personalCategory' thay v√¨ logic split() b·ªã l·ªói
                    const catName = (cat.id === DEFAULT_CATEGORY_ID_PERSONAL) ? translations[currentLang].personalCategory : cat.name;
                    return [cat.id, catName];
                }));
                const canhanCatId = DEFAULT_CATEGORY_ID_PERSONAL;

                const dataForExcel = schedules.map(item => {
                    const categoryId = item.category && categoriesMap.has(item.category) ? item.category : canhanCatId;
                    const trans = translations[currentLang];
                    return {
                        [trans.excelHeaders[0]]: item.title,
                        [trans.excelHeaders[1]]: item.date,
                        [trans.excelHeaders[2]]: item.allDay ? trans.excelAllDay : (item.time || ""),
                        [trans.excelHeaders[3]]: item.allDay ? "" : (item.endTime || ""),
                        [trans.excelHeaders[4]]: categoriesMap.get(categoryId) || "...",
                        [trans.excelHeaders[5]]: item.class || "",
                        [trans.excelHeaders[6]]: item.teacher || "",
                        [trans.excelHeaders[7]]: item.location || "",
                        [trans.excelHeaders[8]]: item.description || "",
                        [trans.excelHeaders[9]]: item.completed ? trans.statusCompleted : trans.statusInProgress // M·ªöI
                    };
                });

                try {
                    const ws = XLSX.utils.json_to_sheet(dataForExcel);
                    // (M·ªöI) ƒê·∫∑t ƒë·ªô r·ªông c·ªôt
                    ws['!cols'] = [
                        { wch: 30 }, // Ti√™u ƒë·ªÅ
                        { wch: 12 }, // Ng√†y
                        { wch: 12 }, // Gi·ªù b·∫Øt ƒë·∫ßu
                        { wch: 12 }, // Gi·ªù k·∫øt th√∫c
                        { wch: 15 }, // Ph√¢n lo·∫°i
                        { wch: 15 }, // L·ªõp
                        { wch: 20 }, // Gi√°o vi√™n d·∫°y
                        { wch: 20 }, // ƒê·ªãa ƒëi·ªÉm
                        { wch: 30 }, // M√¥ t·∫£
                        { wch: 15 }  // Tr·∫°ng th√°i (M·ªöI)
                    ];

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, translations[currentLang].excelSheetName);
                    XLSX.writeFile(wb, `thoi_khoa_bieu_${new Date().toISOString().slice(0, 10)}.xlsx`);
                } catch (e) {
                    console.error("L·ªói khi xu·∫•t Excel:", e);
                    openConfirmModal(translations[currentLang].excelError, "Error", translations[currentLang].notifyOK, () => { });
                }
            }
            exportExcelButton.addEventListener('click', exportToExcel);
            exportExcelButtonDesktop.addEventListener('click', exportToExcel);

            // --- X·ª≠ l√Ω Mobile Sidebar ---
            function openSidebar() {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('open');
            }
            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            }
            menuOpenButton.addEventListener('click', openSidebar);
            menuCloseButton.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
        });
    </script>

    <!-- CSS (C·∫≠p nh·∫≠t cho Ch·∫ø ƒë·ªô T·ªëi v√† Tr·∫°ng th√°i Ho√†n th√†nh) -->
    <style id="dynamic-category-styles"></style>
    <style>
        :root {
            --fc-border-color: #e2e8f0;
            /* gray-200 */
            --fc-today-bg-color: #fefcbf;
            /* yellow-50 */
            --fc-day-text-color: #374151;
            /* gray-700 */
            --fc-header-text-color: #4b5563;
            /* gray-600 */
            --fc-title-text-color: #1f2937;
            /* gray-800 */
        }

        html.dark {
            --fc-border-color: #4b5563;
            /* gray-600 */
            --fc-today-bg-color: rgba(75, 85, 99, 0.5);
            /* gray-600 with opacity */
            --fc-day-text-color: #d1d5db;
            /* gray-300 */
            --fc-header-text-color: #9ca3af;
            /* gray-400 */
            --fc-title-text-color: #f3f4f6;
            /* gray-100 */
        }

        /* (M·ªöI) T√πy ch·ªânh m√†u vƒÉn b·∫£n cho FullCalendar */
        .fc .fc-daygrid-day-number {
            color: var(--fc-day-text-color);
        }

        .fc .fc-col-header-cell-cushion {
            color: var(--fc-header-text-color);
            text-decoration: none;
            /* B·ªè g·∫°ch ch√¢n m·∫∑c ƒë·ªãnh */
        }

        .fc .fc-toolbar-title {
            color: var(--fc-title-text-color);
            font-size: 1.5rem;
            /* (S·ª¨A) 24px - Thu nh·ªè_t·ª´_m·∫∑c_ƒë·ªãnh_28px */
        }

        .fc .fc-button {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
            text-transform: capitalize;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .fc .fc-button:hover {
            background-color: #2563eb;
        }

        .fc .fc-button-primary:not(:disabled).fc-button-active,
        .fc .fc-button-primary:not(:disabled):active {
            background-color: #1d4ed8;
        }

        /* (M·ªöI) S·ª≠a l·ªói n√∫t "H√¥m nay" khi ·ªü ch·∫ø ƒë·ªô t·ªëi */
        html.dark .fc .fc-dayGridMonth-button.fc-button-active,
        html.dark .fc .fc-timeGridWeek-button.fc-button-active,
        html.dark .fc .fc-timeGridDay-button.fc-button-active {
            background-color: #1d4ed8 !important;
        }

        /* (M·ªöI) N√∫t "H√¥m nay" kh√¥ng active ·ªü ch·∫ø ƒë·ªô t·ªëi */
        html.dark .fc .fc-today-button {
            background-color: #3b82f6 !important;
        }

        html.dark .fc .fc-today-button:hover {
            background-color: #2563eb !important;
        }


        .fc-event.event-all-day {
            font-weight: bold;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .search-input {
            padding-left: 2.5rem !important;
        }

        @media (max-width: 768px) {
            .fc .fc-toolbar-title {
                font-size: 1.25rem;
                /* (S·ª¨A) 20px cho mobile */
            }

            .fc .fc-button {
                font-size: 0.875rem;
                padding: 0.4rem 0.8rem;
            }

            .fc .fc-toolbar.fc-header-toolbar {
                /* (S·ª¨A) B·ªë tr√≠ l·∫°i thanh c√¥ng c·ª• cho mobile */
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                /* TƒÉng kho·∫£ng c√°ch m·ªôt ch√∫t */
                align-items: center;
            }

            /* (M·ªöI) Tinh ch·ªânh s·ª± ki·ªán tr√™n mobile cho d·ªÖ ƒë·ªçc */
            .fc-event {
                font-size: 0.75rem !important;
                /* 12px, nh·ªè h∆°n m·∫∑c ƒë·ªãnh */
                padding: 1px 4px !important;
                /* Gi·∫£m padding */
                line-height: 1.3 !important;
                /* Gi·∫£m chi·ªÅu cao d√≤ng */
            }

            /* (M·ªöI) Cho ph√©p ti√™u ƒë·ªÅ s·ª± ki·ªán tr√™n L·ªãch Th√°ng (dayGrid) ƒë∆∞·ª£c ng·∫Øt d√≤ng */
            .fc-daygrid-event {
                white-space: normal !important;
                /* Cho ph√©p ng·∫Øt d√≤ng */
                /* (S·ª¨A) B·ªè overflow: hidden ƒë·ªÉ text (v√† status) c√≥ th·ªÉ wrap v√† hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß */
                /* overflow: hidden; */
                /* ·∫®n ph·∫ßn th·ª´a */
            }

            /* (M·ªöI - GI·∫¢I QUY·∫æT Y√äU C·∫¶U) Thu nh·ªè text header c·ªßa "Tu·∫ßn" (timeGrid) tr√™n mobile */
            .fc .fc-col-header-cell-cushion {
                font-size: 0.75rem !important;
                /* 12px */
                line-height: 1.3 !important;
                /* Gi·∫£m chi·ªÅu cao d√≤ng */
                padding: 2px 0 !important;
                /* Gi·∫£m padding d·ªçc */
                white-space: normal !important;
                /* ƒê·∫£m b·∫£o cho ph√©p ng·∫Øt d√≤ng */
            }
        }

        #sidebar.open {
            transform: translateX(0);
        }

        #sidebarOverlay.open {
            display: block;
        }

        /* (M·ªöI) Style cho input select ng√¥n ng·ªØ */
        .lang-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239ca3af%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.3-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 0.65em auto;
            padding-right: 2rem;
            /* Th√™m kh√¥ng gian cho icon */
        }

        html.dark .lang-select {
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d1d5db%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-13%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2013l128%20128c3.6%203.6%207.8%205.4%2013%205.4s9.4-1.8%2013-5.4l128-128c3.6-3.6%205.4-7.8%205.4-13%200-5-1.8-9.3-5.4-13z%22%2F%3E%3C%2Fsvg%3E');
        }
    </style>
</head>

<!-- (M·ªöI) Th√™m class dark:bg-gray-900 cho body -->

<body
    class="bg-gray-100 dark:bg-gray-900 font-sans leading-normal tracking-normal transition-colors duration-300 flex flex-col min-h-screen">

    <!-- (M·ªöI) M√†n h√¨nh X√°c th·ª±c / T·∫£i (Th√™m style dark) -->
    <div id="authScreen" class="flex items-center justify-center h-screen">
        <div class="text-center p-8 bg-white dark:bg-gray-800 shadow-lg rounded-lg">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-6" data-lang-key="loginWelcome">Ch√†o m·ª´ng
                b·∫°n ƒë·∫øn v·ªõi L·ªãch</h1>
            <p class="text-gray-600 dark:text-gray-300 mb-6" data-lang-key="loginPrompt">Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô
                h√≥a th·ªùi kh√≥a bi·ªÉu c·ªßa b·∫°n.</p>
            <button id="loginButton"
                class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-semibold transition duration-200">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                    <path
                        d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                    <path
                        d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" />
                    <path
                        d="M12 5.38c1.63 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                </svg>
                <span data-lang-key="loginButton">ƒêƒÉng nh·∫≠p b·∫±ng Google</span>
            </button>
            <p id="loginError" class="text-red-600 text-sm mt-4"></p>
        </div>
    </div>

    <!-- (M·ªöI) N·ªôi dung ch√≠nh c·ªßa ·ª®ng d·ª•ng (·∫©n ban ƒë·∫ßu) -->
    <div id="appContent" class="hidden flex-grow w-full">

        <!-- (M·ªöI) Header / Navbar C·ªë ƒë·ªãnh -->
        <nav id="mainHeader" class="sticky top-0 z-20 bg-white dark:bg-gray-800 shadow-md">
            <div class="container mx-auto max-w-7xl px-4">
                <div class="flex justify-between items-center h-16">
                    <!-- Brand v√† N√∫t Mobile -->
                    <div class="flex-shrink-0 flex items-center">
                        <button id="menuOpenButton"
                            class="md:hidden text-gray-700 dark:text-gray-300 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <!-- (S·ª¨A) S·ª≠a l·∫°i_path_c·ªßa_SVG_ƒë·ªÉ_hi·ªÉn_th·ªã_ƒë√∫ng_3_v·∫°ch -->
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16">
                                </path>
                            </svg>
                        </button>
                        <!-- (S·ª¨A) Thu nh·ªè H1 -->
                        <h1 class="text-lg md:text-xl font-bold text-gray-800 dark:text-gray-100 ml-2 md:ml-0"
                            data-lang-key="mainTitle">
                            üìÖ Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu
                        </h1>
                    </div>

                    <!-- Menu Desktop -->
                    <div class="hidden md:flex items-center space-x-2">
                        <!-- T√¨m ki·∫øm -->
                        <div class="relative">
                            <label for="searchInputDesktop" class="sr-only" data-lang-key="searchPlaceholder">T√¨m
                                ki·∫øm</label>
                            <input type="text" id="searchInputDesktop" data-lang-key-placeholder="searchPlaceholder"
                                placeholder="T√¨m ki·∫øm..."
                                class="w-40 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm search-input bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <svg class="w-4 h-4 search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <!-- L·ªçc -->
                        <div class="flex items-center">
                            <label for="categoryFilterDesktop"
                                class="text-sm font-medium text-gray-700 dark:text-gray-300 mr-2"
                                data-lang-key="filterLabel">L·ªçc:</label>
                            <select id="categoryFilterDesktop"
                                class="w-36 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 lang-select">
                                <option value="all" data-lang-key="allOption">T·∫•t c·∫£</option>
                            </select>
                        </div>
                        <!-- C√°c n√∫t -->
                        <button id="manageCategoriesButtonDesktop"
                            class="px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-100 font-medium"
                            data-lang-key="manageCategories">
                            Qu·∫£n l√Ω Ph√¢n lo·∫°i
                        </button>
                        <button id="exportExcelButtonDesktop"
                            class="px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 font-medium"
                            data-lang-key="exportExcel">
                            Xu·∫•t Excel
                        </button>
                        <!-- Ng√¥n ng·ªØ -->
                        <select id="langSwitchDesktop"
                            class="w-24 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 lang-select">
                            <option value="vi">Ti·∫øng Vi·ªát</option>
                            <option value="en">English</option>
                            <option value="fr">Fran√ßais</option>
                        </select>
                        <!-- S√°ng/T·ªëi -->
                        <button id="themeToggleDesktop"
                            class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                            <!-- N·ªôi dung ƒë∆∞·ª£c ch√®n b·ªüi JS -->
                        </button>
                        <!-- Ng∆∞·ªùi d√πng -->
                        <span id="userInfoDisplay"
                            class="text-sm text-gray-700 dark:text-gray-200 font-medium bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full truncate max-w-xs"
                            title="UserID" data-lang-key="connecting">
                            ƒêang k·∫øt n·ªëi...
                        </span>
                        <button id="logoutButtonDesktop"
                            class="px-3 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 font-medium hidden"
                            data-lang-key="logout">
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </nav>


        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebarOverlay" class="hidden md:hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>

        <!-- Sidebar (Mobile) (Th√™m style dark) -->
        <div id="sidebar" class="fixed md:hidden inset-y-0 left-0 z-40
                                w-72 max-w-xs h-screen p-6 bg-white dark:bg-gray-800 shadow-xl
                                transform -translate-x-full
                                transition-transform duration-300 ease-in-out
                                overflow-y-auto">
            <button id="menuCloseButton"
                class="absolute top-4 right-4 text-gray-600 dark:text-gray-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
            <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-6" data-lang-key="menuLabel">Ch·ª©c nƒÉng</h2>
            <div class="flex flex-col gap-4">
                <div class="relative w-full">
                    <label for="searchInput" class="sr-only" data-lang-key="searchPlaceholder">T√¨m ki·∫øm</label>
                    <input type="text" id="searchInput" data-lang-key-placeholder="searchPlaceholder"
                        placeholder="T√¨m ki·∫øm..."
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm search-input bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <svg class="w-4 h-4 search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <div class="flex flex-col gap-2">
                    <label for="categoryFilter" class="text-sm font-medium text-gray-700 dark:text-gray-300"
                        data-lang-key="filterLabel">L·ªçc theo:</label>
                    <select id="categoryFilter"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 lang-select">
                        <option value="all" data-lang-key="allOption">T·∫•t c·∫£</option>
                    </select>
                </div>
                <!-- (M·ªöI) Select Ng√¥n ng·ªØ Mobile -->
                <div class="flex flex-col gap-2">
                    <label for="langSwitch" class="text-sm font-medium text-gray-700 dark:text-gray-300"
                        data-lang-key="language">Ng√¥n ng·ªØ:</label>
                    <select id="langSwitch"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 lang-select">
                        <option value="vi">Ti·∫øng Vi·ªát</option>
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                    </select>
                </div>
                <button id="manageCategoriesButton"
                    class="w-full px-3 py-2 text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-100 font-medium"
                    data-lang-key="manageCategories">
                    Qu·∫£n l√Ω Ph√¢n lo·∫°i
                </button>
                <button id="exportExcelButton"
                    class="w-full px-3 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700 font-medium"
                    data-lang-key="exportExcel">
                    Xu·∫•t Excel
                </button>
                <!-- (M·ªöI) N√∫t Ch·∫ø ƒë·ªô S√°ng/T·ªëi Mobile -->
                <button id="themeToggle"
                    class="w-full px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-100 font-medium flex items-center justify-center gap-2">
                    <!-- N·ªôi dung ƒë∆∞·ª£c ch√®n b·ªüi JS -->
                </button>
                <!-- (M·ªöI) N√∫t ƒêƒÉng xu·∫•t Mobile -->
                <button id="logoutButton"
                    class="w-full px-3 py-2 text-sm bg-red-600 text-white rounded-md hover:bg-red-700 font-medium hidden"
                    data-lang-key="logout">
                    ƒêƒÉng xu·∫•t
                </button>
            </div>
        </div>

        <!-- Main content wrapper (Container c·ªßa L·ªãch) -->
        <div class="container mx-auto max-w-7xl p-4 md:p-8 flex-grow">
            <!-- (S·ª≠a) X√≥a c√°c thanh ƒëi·ªÅu khi·ªÉn c≈© ·ªü ƒë√¢y, v√¨ ƒë√£ chuy·ªÉn l√™n Header -->
            <div id="calendar-container"
                class="bg-white dark:bg-gray-800 p-2 sm:p-6 rounded-lg shadow-xl transition-colors duration-300 h-full">
                <div id="calendar" class="h-full"></div>
            </div>
        </div>

        <!-- Modals (To√†n b·ªô HTML c·ªßa c√°c Modal ƒë∆∞·ª£c c·∫≠p nh·∫≠t cho Ch·∫ø ƒë·ªô T·ªëi v√† Ng√¥n ng·ªØ) -->
        <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <!-- (M·ªöI) Th√™m style dark cho modal -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-lg mx-4 overflow-y-auto"
                style="max-height: 90vh;">
                <h2 id="modalTitle" class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100"
                    data-lang-key="modalTitleAdd">Th√™m S·ª± ki·ªán</h2>
                <form id="eventForm">
                    <input type="hidden" id="eventIdInput" value="">
                    <div class="mb-4">
                        <label for="eventTitle" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="modalTitleLabel">Ti√™u ƒë·ªÅ</label>
                        <input type="text" id="eventTitle"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventDate"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                data-lang-key="modalDateLabel">Ng√†y</label>
                            <input type="date" id="eventDate"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                                required>
                        </div>
                        <div id="timeInputGroup" class="md:col-span-1 grid grid-cols-2 gap-2">
                            <div>
                                <label for="eventTime"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                    data-lang-key="modalTimeStartLabel">Gi·ªù B·∫Øt
                                    ƒë·∫ßu</label>
                                <input type="time" id="eventTime"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="eventEndTime"
                                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                    data-lang-key="modalTimeEndLabel">Gi·ªù K·∫øt
                                    th√∫c</label>

                                <input type="time" id="eventEndTime"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-x-6 gap-y-4 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="eventAllDay"
                                class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                                data-lang-key="modalAllDayLabel">C·∫£ ng√†y</span>
                        </label>
                        <!-- (M·ªöI) Checkbox ƒê√£ ho√†n th√†nh -->
                        <label class="flex items-center">
                            <input type="checkbox" id="eventCompleted"
                                class="h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300"
                                data-lang-key="modalCompletedLabel">ƒê√£ ho√†n th√†nh</span>
                        </label>
                    </div>
                    <div class="mb-4">
                        <label for="eventCategory"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="modalCategoryLabel">Ph√¢n
                            lo·∫°i</label>
                        <select id="eventCategory"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 lang-select"></select>
                    </div>
                    <!-- (M·ªöI) Th√™m tr∆∞·ªùng L·ªõp v√† Gi√°o vi√™n -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="eventClass"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                data-lang-key="modalClassLabel">L·ªõp (T√πy ch·ªçn)</label>
                            <!-- (S·ª¨A) Th√™m list="classList" -->
                            <input type="text" id="eventClass" list="classList"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <!-- (S·ª¨A) Th√™m datalist -->
                            <datalist id="classList"></datalist>
                        </div>
                        <div>
                            <label for="eventTeacher"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                                data-lang-key="modalTeacherLabel">Gi√°o vi√™n (T√πy ch·ªçn)</label>
                            <!-- (S·ª¨A) Th√™m list="teacherList" -->
                            <input type="text" id="eventTeacher" list="teacherList"
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                            <!-- (S·ª¨A) Th√™m datalist -->
                            <datalist id="teacherList"></datalist>
                        </div>
                    </div>
                    <!-- K·∫øt th√∫c tr∆∞·ªùng m·ªõi -->
                    <div class="mb-4">
                        <label for="eventLocation"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="modalLocationLabel">ƒê·ªãa ƒëi·ªÉm (T√πy
                            ch·ªçn)</label>
                        <input type="text" id="eventLocation"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    </div>
                    <div class="mb-4">
                        <label for="eventDescription"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="modalDescriptionLabel">M√¥ t·∫£ (T√πy
                            ch·ªçn)</label>
                        <textarea id="eventDescription" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"></textarea>
                    </div>
                    <div id="timeError" class="text-red-600 dark:text-red-400 text-sm mb-4 hidden"
                        data-lang-key="modalTimeError">L·ªói: Gi·ªù k·∫øt th√∫c ph·∫£i sau gi·ªù b·∫Øt ƒë·∫ßu.
                    </div>
                    <div class="flex justify-between items-center mt-6">
                        <button id="deleteButton" type="button"
                            class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium"
                            data-lang-key="modalDeleteButton">X√≥a</button>
                        <div>
                            <button id="closeModalButton" type="button"
                                class="mr-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500"
                                data-lang-key="modalCloseButton">ƒê√≥ng</button>
                            <button id="saveButton" type="submit"
                                class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700"
                                data-lang-key="modalSaveButton">S·ª≠a</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        <div id="confirmModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <!-- (M·ªöI) Th√™m style dark cho modal -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm mx-4">
                <h2 id="confirmTitle" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100"
                    data-lang-key="confirmTitle">X√°c nh·∫≠n</h2>
                <p id="confirmMessage" class="text-gray-700 dark:text-gray-300 mb-6" data-lang-key="confirmMessage">B·∫°n
                    c√≥ ch·∫Øc ch·∫Øn?</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirmCancel" type="button"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500"
                        data-lang-key="confirmCancel">H·ªßy</button>
                    <button id="confirmOK" type="button"
                        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                        data-lang-key="confirmOK">OK</button>
                </div>
            </div>
        </div>
        <div id="categoryModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <!-- (M·ªöI) Th√™m style dark cho modal -->
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md mx-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-100" data-lang-key="catModalTitle">
                    Qu·∫£n l√Ω Ph√¢n lo·∫°i</h2>
                <form id="addCategoryForm" class="flex flex-col sm:flex-row sm:items-end gap-2 mb-4">
                    <div class="flex-grow w-full">
                        <label for="newCategoryName"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="catModalAddFormLabel">T√™n Ph√¢n
                            lo·∫°i</label>
                        <input type="text" id="newCategoryName"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            required>
                    </div>
                    <div class="w-full sm:w-auto">
                        <label for="newCategoryColor"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="catModalColorLabel">M√†u</label>
                        <input type="color" id="newCategoryColor"
                            class="w-full sm:w-12 h-10 px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700"
                            value="#3b82f6">
                    </div>
                    <button type="submit"
                        class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 h-10"
                        data-lang-key="catModalAddButton">Th√™m</button>
                </form>
                <form id="editCategoryForm" class="hidden flex flex-col gap-2 mb-4">
                    <input type="hidden" id="editCategoryId">
                    <div class="flex-grow w-full">
                        <label for="editCategoryName"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="catModalEditFormLabel">S·ª≠a T√™n Ph√¢n
                            lo·∫°i</label>
                        <input type="text" id="editCategoryName"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                            required>
                    </div>
                    <div class="w-full">
                        <label for="editCategoryColor"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                            data-lang-key="catModalColorLabel">M√†u</Llabel>
                            <input type="color" id="editCategoryColor"
                                class="w-full h-10 px-1 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <button type="submit"
                            class="w-full sm:flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 h-10"
                            data-lang-key="catModalSaveButton">S·ª≠a</button>
                        <button type="button" id="cancelEditButton"
                            class="w-full sm:flex-1 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500 h-10"
                            data-lang-key="catModalCancelButton">H·ªßy</button>
                    </div>
                </form>
                <hr class="my-4 dark:border-gray-600">
                <h3 class="text-lg font-medium text-gray-800 dark:text-gray-100 mb-2"
                    data-lang-key="catModalExistingLabel">C√°c Ph√¢n lo·∫°i Hi·ªán c√≥</h3>
                <div id="categoryList" class="space-y-2 max-h-60 overflow-y-auto text-gray-900 dark:text-gray-100">
                    D</div>
                <div class="flex justify-end mt-6">
                    <button id="closeCategoryModalButton" type="button"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-100 dark:hover:bg-gray-500"
                        data-lang-key="modalCloseButton">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div> <!-- End #appContent -->

    <!-- (M·ªöI) Footer -->
    <footer id="mainFooter" class="w-full text-center p-4 bg-white dark:bg-gray-800 shadow-inner mt-8">
        <p class="text-sm text-gray-600 dark:text-gray-400">
            ¬© 2024 - ·ª®ng d·ª•ng Qu·∫£n l√Ω Th·ªùi kh√≥a bi·ªÉu.
        </p>
    </footer>

</body>

</html>
